<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EcoFix – Sustainable Repair Solutions</title>
<style>
  :root{--green:#2e7d32;--green-dark:#236127;--accent:#43a047;--bg:#f0f8f5;--muted:#666;}
  body{font-family:"Poppins",Arial,sans-serif;margin:0;background:var(--bg);color:#222;}
  header{display:flex;align-items:center;gap:15px;justify-content:center;background:var(--green);color:#fff;padding:18px;}
  header img{width:60px;height:60px;border-radius:10px;object-fit:cover}
  header h1{margin:0;font-size:1.25rem;}
  .container{max-width:1000px;margin:22px auto;padding:0 18px;}
  .overview{background:#e8f5e9;padding:18px;border-radius:12px;margin-bottom:20px;}
  h2{color:var(--green);margin-top:0}
  .products{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:18px;}
  .product{background:#fff;border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);text-align:center;transition:transform .18s ease,box-shadow .18s;}
  .product:hover{transform:translateY(-6px);box-shadow:0 14px 30px rgba(0,0,0,0.08);}
  .product img{width:100%;height:170px;object-fit:cover;border-radius:10px}
  .product h3{margin:10px 0 6px;color:var(--green-dark)}
  .product p{margin:0 0 10px;color:var(--muted);font-size:.95rem}
  .product .price{font-weight:700;color:#111;margin-bottom:8px}
  .product .mock-rating{font-size:13px;color:#444;margin-bottom:8px}
  .btn{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:600;transition:transform .12s,background .12s}
  .btn:hover{transform:scale(1.03);background:var(--green-dark)}
  .cart{background:#f6fff6;padding:14px;border-radius:12px;margin-top:20px}
  #cartList{list-style:none;padding-left:0;margin:0}
  #cartList li{padding:8px 0;border-bottom:1px dashed #e1e1e1;display:flex;justify-content:space-between;align-items:center}
  #cartList li:last-child{border-bottom:none}
  .small{font-size:.9rem;color:var(--muted)}
  .checkout{background:#eaf7ea;padding:16px;border-radius:12px;margin-top:18px}
  .checkout input,.checkout select{width:100%;padding:10px;border-radius:10px;border:1px solid #d9d9d9;margin-top:8px}
  .contact{background:#e8f5e9;padding:16px;border-radius:12px;margin-top:18px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  table th,table td{border:1px solid #e1e1e1;padding:8px;text-align:left;font-size:14px}
  .progress-wrap{background:#eee;border-radius:8px;height:12px;overflow:hidden;width:120px}
  .progress-bar{height:100%;width:0%;background:linear-gradient(90deg,#4caf50,#8bc34a);transition:width .4s linear}
  .status-tag{padding:6px 8px;border-radius:6px;font-weight:600}
  .status-pending{background:#fff4e5;color:#8a5300}
  .status-processing{background:#fff9e6;color:#7a5b00}
  .status-out{background:#e6f7ff;color:#025f8a}
  .status-delivered{background:#e8f5e9;color:#155724}
  .status-cancelled{background:#ffeceb;color:#8a1f1f}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
  .receipt{width:360px;background:#fff;border-radius:12px;padding:18px;box-shadow:0 20px 50px rgba(0,0,0,0.3);font-size:14px}
  .refund{background:#f0fff0;padding:16px;border-radius:12px;margin-top:18px}
  .refund input,.refund textarea,.refund select{width:100%;padding:10px;border-radius:10px;border:1px solid #d9d9d9;margin-top:8px}
  .refund-confirm{background:#dff0d8;color:#2e7d32;padding:8px;border-radius:8px;margin-top:10px;display:none}
  /* rating stars */
  .stars{display:flex;justify-content:center;gap:6px;margin-top:8px}
  .star{font-size:18px;cursor:pointer;color:#ddd}
  .star.active{color:#f5b301}
  .mock-stars{display:inline-block;color:#f5b301;margin-right:6px}
  .mock-meta{font-size:13px;color:#666;display:inline-block}
  /* chat */
  .chat-fab{position:fixed;right:22px;bottom:22px;width:64px;height:64px;border-radius:18px;background:linear-gradient(180deg,var(--accent),#06b6d4);display:flex;align-items:center;justify-content:center;color:#fff;font-size:22px;cursor:pointer;box-shadow:0 12px 30px rgba(2,6,23,0.4);z-index:999}
  .chat-panel{position:fixed;right:22px;bottom:100px;width:340px;max-height:68vh;background:var(--card);border-radius:14px;box-shadow:0 12px 36px rgba(2,6,23,0.35);display:none;flex-direction:column;overflow:hidden;z-index:999}
  .chat-header{padding:12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(90deg,#f6fff6,#ffffff)}
  .chat-body{padding:12px;flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;background:#fbfffb}
  .chat-input{display:flex;border-top:1px solid #eee;padding:8px;gap:8px}
  .bubble{display:inline-block;padding:8px 12px;border-radius:12px;max-width:84%}
  .bubble.user{background:var(--accent);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
  .bubble.ai{background:#f1f1f1;color:#111;align-self:flex-start;border-bottom-left-radius:4px}
  @media (max-width:600px){ .chat-panel{right:12px;left:12px;width:auto} .receipt{width:92vw} }
</style>
</head>
<body>

<header>
  <img src="logo.png" alt="EcoFix Logo" onerror="this.src='https://via.placeholder.com/80x80?text=EcoFix'">
  <h1>EcoFix – Sustainable Repair Solutions</h1>
</header>

<div class="container">
  <div class="overview">
    <h2>Company Overview</h2>
    <p><strong>EcoFix</strong> provides green repair materials like bamboo, coconut fiber, fly ash concrete, and recycled aggregates for sustainable construction.</p>
  </div>

  <h2>Products</h2>
  <div class="products" id="products">
    <div class="product" data-name="Bamboo Reinforcement" data-price="250">
      <img src="bamboo.jpg" alt="Bamboo Reinforcement" onerror="this.src='https://via.placeholder.com/400x300?text=Bamboo'">
      <h3>Bamboo Reinforcement</h3>
      <!-- mock rating displayed under product name -->
      <div class="mock-rating" data-product="Bamboo Reinforcement">
        <span class="mock-stars">★★★★☆</span>
        <span class="mock-meta">4.8 / 5 (132 reviews)</span>
      </div>
      <p class="small">Strong, renewable, ideal for lightweight structural repairs.</p>
      <div class="price">₱250</div>
      <div class="stars" data-product="Bamboo Reinforcement"></div>
      <button class="btn add-to-cart">Add to Cart</button>
    </div>

    <div class="product" data-name="Coconut Fiber Board" data-price="300">
      <img src="coco.jpg" alt="Coconut Fiber Board" onerror="this.src='https://via.placeholder.com/400x300?text=Coconut+Fiber'">
      <h3>Coconut Fiber Board</h3>
      <div class="mock-rating" data-product="Coconut Fiber Board">
        <span class="mock-stars">★★★★☆</span>
        <span class="mock-meta">4.5 / 5 (89 reviews)</span>
      </div>
      <p class="small">Insulation and finishing boards from coconut husk fiber.</p>
      <div class="price">₱300</div>
      <div class="stars" data-product="Coconut Fiber Board"></div>
      <button class="btn add-to-cart">Add to Cart</button>
    </div>

    <div class="product" data-name="Fly Ash Concrete" data-price="220">
      <img src="flyash.jpg" alt="Fly Ash Concrete" onerror="this.src='https://via.placeholder.com/400x300?text=Fly+Ash'">
      <h3>Fly Ash Concrete</h3>
      <div class="mock-rating" data-product="Fly Ash Concrete">
        <span class="mock-stars">★★★★☆</span>
        <span class="mock-meta">4.6 / 5 (210 reviews)</span>
      </div>
      <p class="small">Low-carbon concrete using industrial by-products for strength.</p>
      <div class="price">₱220</div>
      <div class="stars" data-product="Fly Ash Concrete"></div>
      <button class="btn add-to-cart">Add to Cart</button>
    </div>

    <div class="product" data-name="Recycled Aggregates" data-price="180">
      <img src="aggregate.jpg" alt="Recycled Aggregates" onerror="this.src='https://via.placeholder.com/400x300?text=Aggregates'">
      <h3>Recycled Aggregates</h3>
      <div class="mock-rating" data-product="Recycled Aggregates">
        <span class="mock-stars">★★★☆☆</span>
        <span class="mock-meta">3.9 / 5 (47 reviews)</span>
      </div>
      <p class="small">Processed construction debris reused for new builds.</p>
      <div class="price">₱180</div>
      <div class="stars" data-product="Recycled Aggregates"></div>
      <button class="btn add-to-cart">Add to Cart</button>
    </div>
  </div>

  <div class="cart">
    <h2>Cart</h2>
    <ul id="cartList"></ul>
    <div class="small">Tip: You can change quantity in the cart before checkout.</div>
    <h3 id="cartTotal">Total: ₱0</h3>
  </div>

  <div class="checkout">
    <h2>Checkout</h2>
    <label>Full name</label>
    <input id="custName" type="text" placeholder="Your full name">
    <label>Delivery address</label>
    <input id="custAddress" type="text" placeholder="Complete address">
    <label>Mode of payment</label>
    <select id="custPayment">
      <option value="">Select payment</option>
      <option value="Gcash">GCash (+₱10)</option>
      <option value="Bank">Bank Transfer (+₱20)</option>
      <option value="COD">Cash on Delivery (COD)</option>
    </select>
    <div id="paymentDetails" class="small" style="margin-top:8px;"></div>
    <div style="margin-top:12px;">
      <button id="placeOrderBtn" class="btn">Place Order</button>
    </div>

    <h2>Order History & Tracking</h2>
    <table id="orderHistory">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Items</th>
          <th>Total</th>
          <th>Payment</th>
          <th>Status</th>
          <th>ETA</th>
          <th>Progress</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="refund">
    <h2>Refund Request</h2>
    <label>Order ID</label>
    <input id="refundOrderId" type="text" placeholder="Enter your Order ID">
    <label>Reason for Refund</label>
    <textarea id="refundReason" rows="3" placeholder="Describe the issue or reason"></textarea>
    <label>Refund Method</label>
    <select id="refundMethod">
      <option value="">Select method</option>
      <option>GCash</option>
      <option>Bank</option>
    </select>
    <div style="margin-top:12px;">
      <button id="refundBtn" class="btn">Submit Refund</button>
    </div>
    <div class="refund-confirm" id="refundConfirm">✅ Refund request submitted! We'll contact you shortly.</div>
  </div>

  <div class="contact">
    <h2>Contact</h2>
    <p class="small">Email: support@ecofix.com • Phone: +63 912 345 6789</p>
  </div>
</div>

<!-- Payment Confirmation Modal -->
<div class="modal-backdrop" id="paymentConfirmModal" role="dialog" aria-hidden="true">
  <div class="receipt" id="paymentConfirmContent">
    <h3>Confirm Payment</h3>
    <div class="meta" id="confirmMeta"></div>
    <div id="confirmItems"></div>
    <div id="confirmAmount" style="margin-top:8px;font-weight:800"></div>
    <div class="small" id="confirmFeeNote" style="color:#8a1f1f;margin-top:6px"></div>
    <div class="actions" style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button id="confirmCancelBtn" class="close-btn">Cancel</button>
      <button id="confirmPaymentBtn" class="print-btn">Confirm Payment</button>
    </div>
  </div>
</div>

<!-- Receipt Modal -->
<div class="modal-backdrop" id="receiptModal" role="dialog" aria-hidden="true">
  <div class="receipt" id="receiptContent">
    <h3>EcoFix Receipt</h3>
    <div class="meta" id="receiptMeta"></div>
    <div><strong>Customer</strong><div id="rName" class="small"></div></div>
    <div style="margin-top:8px"><strong>Address</strong><div id="rAddress" class="small"></div></div>
    <table id="receiptItems" aria-hidden="false"></table>
    <div class="total" id="receiptTotal"></div>
    <div class="small" id="receiptFeeNote" style="margin-top:8px;color:#8a1f1f;"></div>
    <div class="actions">
      <button class="print-btn" onclick="printReceipt()">Print</button>
      <button class="close-btn" onclick="closeReceipt()">Close</button>
    </div>
  </div>
</div>

<!-- Chat Floating Button + Panel -->
<div class="chat-fab" id="chatFab" title="Chat with EcoAssist">💬</div>
<div class="chat-panel" id="chatPanel" aria-hidden="true">
  <div class="chat-header">
    <div><strong>EcoAssist</strong><div class="small">Offline assistant</div></div>
    <div><button class="btn" id="closeChat" style="padding:6px 10px;border-radius:8px;background:#eee;color:#111">Close</button></div>
  </div>
  <div class="chat-body" id="chatBody"></div>
  <div class="chat-input">
    <input id="chatInput" type="text" placeholder="Ask about products, your order, or refunds..." style="flex:1;padding:10px;border:none;outline:none">
    <button id="chatSend" class="btn">Send</button>
  </div>
</div>

<script>
/* ---------- Configuration & Mock ratings ---------- */
const PAYMENT_FEES = { 'Gcash': 10, 'Bank': 20, 'COD': 0 };
const ETA_MIN_DAYS = 3;
const ETA_MAX_DAYS = 5;

// mock community ratings per product (different per product)
const MOCK_RATINGS = {
  "Bamboo Reinforcement": { avg: 4.8, count: 132 },
  "Coconut Fiber Board": { avg: 4.5, count: 89 },
  "Fly Ash Concrete": { avg: 4.6, count: 210 },
  "Recycled Aggregates": { avg: 3.9, count: 47 }
};

/* ---------- Data stores ---------- */
const cart = []; // {name,price,qty}
const orders = []; // {id, items, subtotal, fee, total, payment, status, progress, etaFrom, etaTo, _trackingInterval, cancelledAt, placedAt}

/* ---------- Helpers ---------- */
function generateOrderId(){ return 'ECO' + Date.now().toString(36).toUpperCase().slice(-8); }
function daysFromNow(n){ const d=new Date(); d.setDate(d.getDate()+n); return d.toLocaleDateString(); }
function formatETA(from,to){ return `${from} – ${to}`; }

/* ---------- Cart logic ---------- */
const cartList = document.getElementById('cartList');
const cartTotalEl = document.getElementById('cartTotal');

function addToCartFromBtn(btn){
  const card = btn.closest('.product');
  const name = card.dataset.name || card.querySelector('h3').innerText;
  const price = Number(card.dataset.price || card.querySelector('.price')?.innerText.replace(/[^0-9.-]+/g,"") || 0);
  addToCart(name, price);
}
function addToCart(name, price){
  const existing = cart.find(i => i.name === name);
  if(existing) existing.qty++;
  else cart.push({name, price, qty:1});
  renderCart();
}
function renderCart(){
  cartList.innerHTML = '';
  let total = 0;
  cart.forEach((it, idx) => {
    total += it.price * it.qty;
    const li = document.createElement('li');
    li.innerHTML = `
      <div style="flex:1">
        <strong>${it.name}</strong><div class="small">₱${it.price} x ${it.qty}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button onclick="changeQty(${idx},-1)" style="padding:6px;border-radius:8px;border:1px solid #ddd;background:#fff">-</button>
        <button onclick="changeQty(${idx},1)" style="padding:6px;border-radius:8px;border:1px solid #ddd;background:#fff">+</button>
        <button onclick="removeItem(${idx})" style="padding:6px;border-radius:8px;border:1px solid #eee;background:#fff">Remove</button>
      </div>`;
    li.style.display = 'flex';
    li.style.justifyContent = 'space-between';
    li.style.alignItems = 'center';
    cartList.appendChild(li);
  });
  cartTotalEl.innerText = `Total: ₱${total}`;
}
function changeQty(i, delta){ cart[i].qty = Math.max(1, cart[i].qty + delta); renderCart(); }
function removeItem(i){ cart.splice(i,1); renderCart(); }
document.querySelectorAll('.add-to-cart').forEach(btn => btn.addEventListener('click', (e) => { addToCartFromBtn(e.target); }));

/* ---------- Ratings (mock + user) ---------- */
function renderMockRatings(){
  document.querySelectorAll('.mock-rating').forEach(el=>{
    const product = el.dataset.product;
    const m = MOCK_RATINGS[product];
    if(!m) return;
    // show star icons approx (rounded to nearest half)
    const avg = m.avg;
    // render stars visually (simple full star / empty star)
    let stars = '';
    const full = Math.floor(avg);
    const half = (avg - full) >= 0.5;
    for(let i=0;i<full;i++) stars += '★';
    if(half) stars += '☆'; // keep it simple (visual)
    while(stars.length < 4) stars += '☆';
    // place output
    el.innerHTML = `<span class="mock-stars">${'★'.repeat(full)}${half?'½':''}</span><span class="mock-meta">${avg.toFixed(1)} / 5 (${m.count} reviews)</span>`;
  });
}

function initUserRatings(){
  document.querySelectorAll('.stars').forEach(container => {
    const product = container.dataset.product;
    container.innerHTML = '';
    const stored = Number(localStorage.getItem('rating_' + product) || 0);
    for(let i=1;i<=5;i++){
      const span = document.createElement('span');
      span.className = 'star' + (i <= stored ? ' active' : '');
      span.innerHTML = '★';
      span.addEventListener('click', ()=> setUserRating(product, i, container));
      container.appendChild(span);
    }
    const lbl = document.createElement('div');
    lbl.className = 'small';
    lbl.style.marginTop = '6px';
    lbl.textContent = stored ? `You: ${stored}/5` : 'You: Rate';
    container.appendChild(lbl);
  });
}
function setUserRating(product, value, container){
  localStorage.setItem('rating_' + product, value);
  const stars = container.querySelectorAll('.star');
  stars.forEach((s, idx)=> s.classList.toggle('active', idx < value));
  const lbl = container.querySelector('.small');
  if(lbl) lbl.textContent = `You: ${value}/5 — Thanks for rating!`;
  addAIMessage(`EcoAssist: Thanks — you rated ${product} ${value}/5.`);
}

/* ---------- Payment Confirm & Order flow ---------- */
const paymentConfirmModal = document.getElementById('paymentConfirmModal');
const confirmMeta = document.getElementById('confirmMeta');
const confirmItems = document.getElementById('confirmItems');
const confirmAmount = document.getElementById('confirmAmount');
const confirmFeeNote = document.getElementById('confirmFeeNote');
const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
const confirmCancelBtn = document.getElementById('confirmCancelBtn');
let pendingOrderPayload = null;

function openPaymentConfirmation(payload){
  pendingOrderPayload = payload;
  confirmMeta.innerText = `Confirm payment · ${new Date().toLocaleString()}`;
  confirmItems.innerHTML = '';
  payload.items.forEach(it=>{
    const d = document.createElement('div'); d.className='small'; d.style.marginBottom='6px';
    d.innerHTML = `<strong>${it.name}</strong> x ${it.qty} — ₱${it.price*it.qty}`;
    confirmItems.appendChild(d);
  });
  confirmAmount.innerText = `Total to pay: ₱${payload.total}`;
  confirmFeeNote.innerText = payload.fee > 0 ? `Processing fee ₱${payload.fee} is non-refundable if you cancel.` : '';
  paymentConfirmModal.style.display = 'flex';
}
confirmCancelBtn.addEventListener('click', ()=>{ pendingOrderPayload = null; paymentConfirmModal.style.display = 'none'; });
confirmPaymentBtn.addEventListener('click', ()=>{ if(!pendingOrderPayload) return; finalizeOrder(pendingOrderPayload); pendingOrderPayload = null; paymentConfirmModal.style.display='none'; });

/* show confirm on Place Order click */
const custPaymentEl = document.getElementById('custPayment');
const paymentDetails = document.getElementById('paymentDetails');
function placeOrderRequest(){
  const name = document.getElementById('custName').value.trim();
  const address = document.getElementById('custAddress').value.trim();
  const payment = custPaymentEl.value;
  if(!name || !address || !payment){ alert('Please complete name, address, and payment method.'); return; }
  if(cart.length === 0){ alert('Your cart is empty.'); return; }
  const itemsCopy = cart.map(i=>({...i}));
  const subtotal = itemsCopy.reduce((s,it)=>s+it.price*it.qty,0);
  const fee = PAYMENT_FEES[payment] || 0;
  const total = subtotal + fee;
  const etaFrom = daysFromNow(ETA_MIN_DAYS);
  const etaTo = daysFromNow(ETA_MAX_DAYS);
  openPaymentConfirmation({ name, address, payment, items: itemsCopy, subtotal, fee, total, etaFrom, etaTo });
}
document.getElementById('placeOrderBtn').addEventListener('click', placeOrderRequest);

/* finalize order after confirmation */
function finalizeOrder(payload){
  const id = generateOrderId();
  const date = new Date().toLocaleString();
  const order = { id, items: payload.items, subtotal: payload.subtotal, fee: payload.fee, total: payload.total, payment: payload.payment, status: (payload.payment==='COD'?'Pending':'Processing'), progress: (payload.payment==='COD'?0:5), etaFrom: payload.etaFrom, etaTo: payload.etaTo, _trackingInterval:null, cancelledAt:null, placedAt: date };
  orders.unshift(order);
  renderOrders();
  // show receipt
  document.getElementById('receiptMeta').innerText = `Order #${id} · ${date} · ${payload.payment}`;
  document.getElementById('rName').innerText = payload.name;
  document.getElementById('rAddress').innerText = payload.address;
  receiptItems.innerHTML = '';
  payload.items.forEach(it=>{ const row=document.createElement('tr'); row.innerHTML=`<td style="text-align:left">${it.name} x ${it.qty}</td><td style="text-align:right">₱${it.price*it.qty}</td>`; receiptItems.appendChild(row); });
  receiptTotal.innerHTML = `<div class="small">Subtotal: ₱${payload.subtotal}</div><div class="small">Payment fee: ₱${payload.fee}</div><div class="total">Total: ₱${payload.total}</div><div class="small">Estimated Delivery: ${formatETA(payload.etaFrom,payload.etaTo)}</div>`;
  document.getElementById('receiptFeeNote').innerText = payload.fee>0 ? `Note: Payment fee of ₱${payload.fee} is non-refundable if you cancel the order.` : '';
  document.getElementById('receiptModal').style.display = 'flex';
  // clear cart & fields
  cart.length=0; renderCart();
  document.getElementById('custName').value=''; document.getElementById('custAddress').value=''; custPaymentEl.value=''; paymentDetails.innerHTML='';
}

/* ---------- Order history rendering ---------- */
const orderHistoryBody = document.querySelector('#orderHistory tbody');
function statusTagHTML(status){
  if(status==='Pending') return `<span class="status-tag status-pending">Pending</span>`;
  if(status==='Processing') return `<span class="status-tag status-processing">Processing</span>`;
  if(status==='Out for Delivery') return `<span class="status-tag status-out">Out for Delivery</span>`;
  if(status==='Delivered') return `<span class="status-tag status-delivered">Delivered</span>`;
  if(status==='Cancelled') return `<span class="status-tag status-cancelled">Cancelled</span>`;
  return `<span class="status-tag">${status}</span>`;
}
function isCancellable(status){ return (status==='Pending' || status==='Processing'); }

function renderOrders(){
  orderHistoryBody.innerHTML='';
  orders.forEach((o, idx) => {
    const items = o.items.map(it=>`${it.name} x${it.qty}`).join(', ');
    const progId = `prog-${o.id}`;
    const actionParts = [];
    if(o.status === 'Pending') actionParts.push(`<button class="btn" onclick="markPaid(${idx})" style="padding:6px 8px;">Mark Paid</button>`);
    actionParts.push(`<button class="btn" onclick="startTracking(${idx})" style="padding:6px 8px;background:#1976d2">Track Delivery</button>`);
    if(isCancellable(o.status)) actionParts.push(`<button class="btn" onclick="cancelOrder(${idx})" style="padding:6px 8px;background:#f44336">Cancel</button>`);
    else actionParts.push(`<button class="btn" disabled style="padding:6px 8px;background:#eee;color:#666;cursor:not-allowed">Cancel</button>`);
    actionParts.push(`<button class="btn" onclick="openOrderDetails(${idx})" style="padding:6px 8px;background:#999">Details</button>`);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${o.id}</td>
      <td>${items}</td>
      <td>₱${o.total} ${o.fee>0?`<div class="small">fee: ₱${o.fee}</div>`:''}</td>
      <td>${o.payment}</td>
      <td>${statusTagHTML(o.status)}</td>
      <td>${formatETA(o.etaFrom,o.etaTo)}</td>
      <td><div class="progress-wrap" title="${Math.round(o.progress||0)}%"><div id="${progId}" class="progress-bar" style="width:${o.progress||0}%"></div></div></td>
      <td style="display:flex;gap:6px;flex-wrap:wrap">${actionParts.join('')}</td>
    `;
    orderHistoryBody.appendChild(tr);
  });
}

/* ---------- Mark paid ---------- */
function markPaid(index){
  const o = orders[index];
  if(!o) return;
  if(o.status !== 'Pending'){ alert('Order cannot be marked paid at this time.'); return; }
  o.status = 'Processing'; o.progress = 5; renderOrders(); addAIMessage(`EcoAssist: Order ${o.id} marked as Paid — processing has started.`);
}

/* ---------- Cancel order ---------- */
function cancelOrder(index){
  const o = orders[index];
  if(!o) return;
  if(!isCancellable(o.status)){ alert('This order cannot be cancelled.'); return; }
  if(!confirm(`Cancel order ${o.id}? Note: payment fee of ₱${o.fee} (if any) is non-refundable.`)) return;
  if(o._trackingInterval){ clearInterval(o._trackingInterval); o._trackingInterval = null; }
  o.status = 'Cancelled'; o.progress = 0; o.cancelledAt = new Date().toLocaleString(); renderOrders();
  addAIMessage(`EcoAssist: Order ${o.id} has been cancelled. Payment fee of ₱${o.fee} is non-refundable and will be retained.`);
}

/* ---------- Order details ---------- */
function openOrderDetails(index){
  const o = orders[index];
  if(!o) return;
  document.getElementById('receiptModal').style.display='flex';
  document.getElementById('receiptMeta').innerText = `Order #${o.id} · ${o.placedAt} · ${o.payment}`;
  document.getElementById('rName').innerText = '(Order details)';
  document.getElementById('rAddress').innerText = '';
  receiptItems.innerHTML = '';
  o.items.forEach(it=>{ const r=document.createElement('tr'); r.innerHTML=`<td>${it.name} x${it.qty}</td><td style="text-align:right">₱${it.price*it.qty}</td>`; receiptItems.appendChild(r); });
  receiptTotal.innerHTML = `<div class="small">Subtotal: ₱${o.subtotal}</div><div class="small">Processing fee: ₱${o.fee}</div><div class="total">Total: ₱${o.total}</div><div class="small">Estimated Delivery: ${formatETA(o.etaFrom,o.etaTo)}</div>${o.cancelledAt?`<div class="small" style="color:#8a1f1f">Cancelled at: ${o.cancelledAt}</div>`:''}`;
  document.getElementById('receiptFeeNote').innerText = o.fee>0 ? `Note: Payment fee of ₱${o.fee} is non-refundable if you cancel.` : '';
  document.getElementById('refundOrderId').value = o.id;
}

/* ---------- Tracking simulation ---------- */
function startTracking(index){
  const order = orders[index];
  if(!order) return;
  if(order.status === 'Delivered'){ alert('Order already delivered.'); return; }
  if(order.status === 'Cancelled'){ alert('Order was cancelled.'); return; }
  if(order.payment === 'COD' && order.status === 'Pending'){
    if(!confirm('This order is COD and still Pending. Mark it as Paid now to start tracking?')) return;
    markPaid(index);
  }
  addAIMessage(`EcoAssist: Tracking started for order ${order.id}.`);
  const steps = [{status:'Processing',target:30},{status:'Out for Delivery',target:80},{status:'Delivered',target:100}];
  let step = 0;
  if(order._trackingInterval) clearInterval(order._trackingInterval);
  order._trackingInterval = setInterval(()=>{
    if(order.status === 'Cancelled'){ clearInterval(order._trackingInterval); order._trackingInterval=null; renderOrders(); return; }
    const currentStep = steps[step];
    const increment = 6;
    order.progress = Math.min((order.progress||0)+increment, currentStep.target);
    const bar = document.getElementById(`prog-${order.id}`); if(bar) bar.style.width = order.progress + '%';
    if(order.progress >= currentStep.target){
      order.status = currentStep.status; renderOrders(); addAIMessage(`EcoAssist: Order ${order.id} is now ${order.status}.`); step++;
      if(step >= steps.length){ if(order._trackingInterval){ clearInterval(order._trackingInterval); order._trackingInterval=null; } }
    }
  }, 1800);
}

/* ---------- Refund handling (Store Credit removed) ---------- */
document.getElementById('refundBtn').addEventListener('click', ()=>{
  const id = document.getElementById('refundOrderId').value.trim();
  const reason = document.getElementById('refundReason').value.trim();
  const method = document.getElementById('refundMethod').value;
  if(!id || !reason || !method){ alert('Please provide Order ID, reason, and refund method.'); return; }
  document.getElementById('refundConfirm').style.display = 'block';
  addAIMessage(`EcoAssist: Refund request for ${id} received (method: ${method}). Note: payment processing fees (if any) are non-refundable for cancelled orders.`);
  document.getElementById('refundOrderId').value=''; document.getElementById('refundReason').value=''; document.getElementById('refundMethod').value='';
  setTimeout(()=>{ document.getElementById('refundConfirm').style.display='none'; }, 4000);
});

/* ---------- Payment option fields ---------- */
custPaymentEl.addEventListener('change', ()=>{
  const choice = custPaymentEl.value;
  paymentDetails.innerHTML = '';
  if(choice==='Gcash'){ paymentDetails.innerHTML = `<div class="small">Processing fee: ₱${PAYMENT_FEES['Gcash']} (non-refundable on cancel)</div><label class="small">GCash number</label><input id="gcashNumber" placeholder="09XXXXXXXXX">`; }
  else if(choice==='Bank'){ paymentDetails.innerHTML = `<div class="small">Processing fee: ₱${PAYMENT_FEES['Bank']} (non-refundable on cancel)</div><label class="small">Bank</label><select id="bankName"><option value="">Select bank</option><option>BDO</option><option>BPI</option><option>Metrobank</option></select><label class="small" style="margin-top:8px;display:block">Account no.</label><input id="bankAccountNumber" placeholder="Account number">`; }
  else if(choice==='COD'){ paymentDetails.innerHTML = `<div class="small">No processing fee for COD.</div>`; }
});

/* ---------- AI Chat (updated) ---------- */
const chatFab = document.getElementById('chatFab');
const chatPanel = document.getElementById('chatPanel');
const chatBody = document.getElementById('chatBody');
const chatInput = document.getElementById('chatInput');
const chatSend = document.getElementById('chatSend');

function openChat(){ chatPanel.style.display = 'flex'; chatInput.focus(); }
function closeChat(){ chatPanel.style.display = 'none'; }
chatFab.addEventListener('click', openChat);
document.getElementById('closeChat').addEventListener('click', closeChat);

function appendChatBubble(role, text){ const div=document.createElement('div'); div.className='bubble '+(role==='user'?'user':'ai'); div.textContent=text; chatBody.appendChild(div); chatBody.scrollTop=chatBody.scrollHeight; }

function aiReply(text){
  const t=text.toLowerCase();
  if(t.includes('price')||t.includes('cost')) return 'Prices: Bamboo ₱250, Coconut Fiber Board ₱300, Fly Ash Concrete ₱220, Recycled Aggregates ₱180. Payment fees: GCash ₱10, Bank ₱20, COD ₱0.';
  if(t.includes('refund')) return 'Refunds: use the Refund section. Processing fees are non-refundable for cancelled orders.';
  if(t.includes('track')||t.includes('status')) return 'Open Order History and click "Track Delivery" for live progress updates; ETA appears in the ETA column.';
  if(t.includes('eta')||t.includes('delivery')) return 'ETA is shown on the receipt and Order History (typically 3–5 days after order).';
  if(t.includes('confirm')||t.includes('payment')) return 'After clicking Place Order you will see a confirmation popup summarizing total (including fees). Confirm to finalize payment.';
  if(t.includes('rating')||t.includes('rate')) return 'Mock community ratings appear under the product name; you can add your personal rating with the stars.';
  if(t.includes('cancel')) return 'To cancel an order, go to Order History and click Cancel on orders marked Pending or Processing. Fees may be non-refundable.';
  if(t.includes('order')) return 'Place your order using Checkout — receipts with Order ID, ETA and fee details appear after confirmation.';
  if(t.includes('hello')||t.includes('hi')) return "Hi! I'm EcoAssist — I can help with product info, fees, ratings, and order tracking.";
  return 'I can help with product info, orders, fees, ETA, ratings, and refunds — try "price", "track", "cancel order", or "refund".';
}

let chatLocked=false;
chatSend.addEventListener('click', ()=>{
  if(chatLocked) return;
  const txt=chatInput.value.trim(); if(!txt)return;
  appendChatBubble('user', txt); chatInput.value=''; chatLocked=true;
  const typing=document.createElement('div'); typing.id='typingDots'; typing.innerHTML='<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>'; chatBody.appendChild(typing); chatBody.scrollTop=chatBody.scrollHeight;
  setTimeout(()=>{ const reply=aiReply(txt); const dots=document.getElementById('typingDots'); if(dots) dots.remove(); appendChatBubble('ai', reply); chatLocked=false; },700);
});
setTimeout(()=> appendChatBubble('ai', "Hello! I'm EcoAssist — I can help with product info, fees, ratings, and order tracking."),600);

function addAIMessage(text){ chatPanel.style.display='flex'; appendChatBubble('ai', text); }

/* ---------- Print / close receipt ---------- */
function closeReceipt(){ document.getElementById('receiptModal').style.display = 'none'; }
function printReceipt(){ const content=document.getElementById('receiptContent').innerHTML; const w=window.open('','_blank','width=600,height=700'); w.document.write(`<html><head><title>Receipt</title></head><body>${content}</body></html>`); w.document.close(); w.focus(); setTimeout(()=>w.print(),300); }

/* ---------- Init ---------- */
function initAll(){
  renderCart();
  renderOrders();
  renderMockRatings();
  initUserRatings();
}
initAll();
</script>
</body>
</html>
