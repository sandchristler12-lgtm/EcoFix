<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EcoFix â€“ Sustainable Repair Solutions</title>
<style>
  :root{--green:#2e7d32;--green-dark:#236127;--accent:#43a047;--bg:#f0f8f5;--muted:#666;}
  body{font-family:"Poppins",Arial,sans-serif;margin:0;background:var(--bg);color:#222;}
  header{display:flex;align-items:center;gap:15px;justify-content:center;background:var(--green);color:#fff;padding:18px;}
  header img{width:60px;height:60px;border-radius:10px;object-fit:cover}
  header h1{margin:0;font-size:1.25rem;}
  .container{max-width:1000px;margin:22px auto;padding:0 18px;}
  .overview{background:#e8f5e9;padding:18px;border-radius:12px;margin-bottom:20px;}
  h2{color:var(--green);margin-top:0}
  .products{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:18px;}
  .product{background:#fff;border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);text-align:center;transition:transform .18s ease,box-shadow .18s;}
  .product:hover{transform:translateY(-6px);box-shadow:0 14px 30px rgba(0,0,0,0.08);}
  .product img{width:100%;height:170px;object-fit:cover;border-radius:10px}
  .product h3{margin:10px 0 6px;color:var(--green-dark)}
  .product p{margin:0 0 10px;color:var(--muted);font-size:.95rem}
  .product .price{font-weight:700;color:#111;margin-bottom:8px}
  .product .mock-rating{font-size:13px;color:#444;margin-bottom:8px}
  .btn{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:600;transition:transform .12s,background .12s}
  .btn:hover{transform:scale(1.03);background:var(--green-dark)}
  .cart{background:#f6fff6;padding:14px;border-radius:12px;margin-top:20px}
  #cartList{list-style:none;padding-left:0;margin:0}
  #cartList li{padding:8px 0;border-bottom:1px dashed #e1e1e1;display:flex;justify-content:space-between;align-items:center}
  #cartList li:last-child{border-bottom:none}
  .small{font-size:.9rem;color:var(--muted)}
  .checkout{background:#eaf7ea;padding:16px;border-radius:12px;margin-top:18px}
  .checkout input,.checkout select{width:100%;padding:10px;border-radius:10px;border:1px solid #d9d9d9;margin-top:8px}
  .contact{background:#e8f5e9;padding:16px;border-radius:12px;margin-top:18px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  table th,table td{border:1px solid #e1e1e1;padding:8px;text-align:left;font-size:14px}
  .progress-wrap{background:#eee;border-radius:8px;height:12px;overflow:hidden;width:120px}
  .progress-bar{height:100%;width:0%;background:linear-gradient(90deg,#4caf50,#8bc34a);transition:width .4s linear}
  .status-tag{padding:6px 8px;border-radius:6px;font-weight:600}
  .status-pending{background:#fff4e5;color:#8a5300}
  .status-processing{background:#fff9e6;color:#7a5b00}
  .status-out{background:#e6f7ff;color:#025f8a}
  .status-delivered{background:#e8f5e9;color:#155724}
  .status-cancelled{background:#ffeceb;color:#8a1f1f}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
  .receipt{width:360px;background:#fff;border-radius:12px;padding:18px;box-shadow:0 20px 50px rgba(0,0,0,0.3);font-size:14px}
  .refund{background:#f0fff0;padding:16px;border-radius:12px;margin-top:18px}
  .refund input,.refund textarea,.refund select{width:100%;padding:10px;border-radius:10px;border:1px solid #d9d9d9;margin-top:8px}
  .refund-confirm{background:#dff0d8;color:#2e7d32;padding:8px;border-radius:8px;margin-top:10px;display:none}
  /* rating stars */
  .stars{display:flex;justify-content:center;gap:6px;margin-top:8px}
  .star{font-size:18px;cursor:pointer;color:#ddd}
  .star.active{color:#f5b301}
  .mock-stars{display:inline-block;color:#f5b301;margin-right:6px}
  .mock-meta{font-size:13px;color:#666;display:inline-block}
  /* chat */
  .chat-fab{position:fixed;right:22px;bottom:22px;width:64px;height:64px;border-radius:18px;background:linear-gradient(180deg,var(--accent),#06b6d4);display:flex;align-items:center;justify-content:center;color:#fff;font-size:22px;cursor:pointer;box-shadow:0 12px 30px rgba(2,6,23,0.4);z-index:999}
  .chat-panel{position:fixed;right:22px;bottom:100px;width:340px;max-height:68vh;background:var(--card);border-radius:14px;box-shadow:0 12px 36px rgba(2,6,23,0.35);display:none;flex-direction:column;overflow:hidden;z-index:999}
  .chat-header{padding:12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(90deg,#f6fff6,#ffffff)}
  .chat-body{padding:12px;flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;background:#fbfffb}
  .chat-input{display:flex;border-top:1px solid #eee;padding:8px;gap:8px}
  .chat-card{background:#fff;border-radius:10px;padding:8px;border:1px solid #eee;display:flex;gap:8px;align-items:center}
  .chat-card img{width:60px;height:40px;object-fit:cover;border-radius:6px}
  .chat-card .info{flex:1}
  .bubble{display:inline-block;padding:8px 12px;border-radius:12px;max-width:84%}
  .bubble.user{background:var(--accent);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
  .bubble.ai{background:#f1f1f1;color:#111;align-self:flex-start;border-bottom-left-radius:4px}
  .input-warning{color:#b71c1c;font-size:12px;margin-top:6px}
  @media (max-width:600px){ .chat-panel{right:12px;left:12px;width:auto} .receipt{width:92vw} }
</style>
</head>
<body>

<header>
  <img src="logo.png" alt="EcoFix Logo" onerror="this.src='https://via.placeholder.com/80x80?text=EcoFix'">
  <h1>EcoFix â€“ Sustainable Repair Solutions</h1>
</header>

<div class="container">
  <div class="overview">
    <h2>Company Overview</h2>
    <p><strong>EcoFix</strong> provides green repair materials like bamboo, coconut fiber, fly ash concrete, and recycled aggregates for sustainable construction.</p>
  </div>

  <h2>Products</h2>
  <div class="products" id="products">
    <div class="product" data-name="Bamboo Reinforcement" data-price="250" data-desc="Renewable, strong alternative for light reinforcement.">
      <img src="bamboo.jpg" alt="Bamboo Reinforcement" onerror="this.src='https://via.placeholder.com/400x300?text=Bamboo'">
      <h3>Bamboo Reinforcement</h3>
      <div class="mock-rating" data-product="Bamboo Reinforcement">
        <span class="mock-stars">â˜…â˜…â˜…â˜…â˜†</span>
        <span class="mock-meta">4.8 / 5 (132 reviews)</span>
      </div>
      <p class="small">Strong, renewable, ideal for lightweight structural repairs.</p>
      <div class="price">â‚±250</div>
      <div class="stars" data-product="Bamboo Reinforcement"></div>
      <button class="btn add-to-cart">Add to Cart</button>
    </div>

    <div class="product" data-name="Coconut Fiber Board" data-price="300" data-desc="Moderate insulation and finishing board from coconut husk fibers.">
      <img src="coco.jpg" alt="Coconut Fiber Board" onerror="this.src='https://via.placeholder.com/400x300?text=Coconut+Fiber'">
      <h3>Coconut Fiber Board</h3>
      <div class="mock-rating" data-product="Coconut Fiber Board">
        <span class="mock-stars">â˜…â˜…â˜…â˜…â˜†</span>
        <span class="mock-meta">4.5 / 5 (89 reviews)</span>
      </div>
      <p class="small">Insulation and finishing boards from coconut husk fiber.</p>
      <div class="price">â‚±300</div>
      <div class="stars" data-product="Coconut Fiber Board"></div>
      <button class="btn add-to-cart">Add to Cart</button>
    </div>

    <div class="product" data-name="Fly Ash Concrete" data-price="220" data-desc="Low-carbon concrete using industrial by-products for strong mixes.">
      <img src="flyash.jpg" alt="Fly Ash Concrete" onerror="this.src='https://via.placeholder.com/400x300?text=Fly+Ash'">
      <h3>Fly Ash Concrete</h3>
      <div class="mock-rating" data-product="Fly Ash Concrete">
        <span class="mock-stars">â˜…â˜…â˜…â˜…â˜†</span>
        <span class="mock-meta">4.6 / 5 (210 reviews)</span>
      </div>
      <p class="small">Low-carbon concrete using industrial by-products for strength.</p>
      <div class="price">â‚±220</div>
      <div class="stars" data-product="Fly Ash Concrete"></div>
      <button class="btn add-to-cart">Add to Cart</button>
    </div>

    <div class="product" data-name="Recycled Aggregates" data-price="180" data-desc="Processed construction debris used for base and fill work.">
      <img src="aggregate.jpg" alt="Recycled Aggregates" onerror="this.src='https://via.placeholder.com/400x300?text=Aggregates'">
      <h3>Recycled Aggregates</h3>
      <div class="mock-rating" data-product="Recycled Aggregates">
        <span class="mock-stars">â˜…â˜…â˜…â˜†â˜†</span>
        <span class="mock-meta">3.9 / 5 (47 reviews)</span>
      </div>
      <p class="small">Processed construction debris reused for new builds.</p>
      <div class="price">â‚±180</div>
      <div class="stars" data-product="Recycled Aggregates"></div>
      <button class="btn add-to-cart">Add to Cart</button>
    </div>
  </div>

  <div class="cart">
    <h2>Cart</h2>
    <ul id="cartList"></ul>
    <div class="small">Tip: You can change quantity in the cart before checkout.</div>
    <h3 id="cartTotal">Total: â‚±0</h3>
  </div>

  <div class="checkout">
    <h2>Checkout</h2>
    <label>Full name</label>
    <input id="custName" type="text" placeholder="Your full name">
    <label>Delivery address</label>
    <input id="custAddress" type="text" placeholder="Complete address">
    <label>Mode of payment</label>
    <select id="custPayment">
      <option value="">Select payment</option>
      <option value="Gcash">GCash (+â‚±10)</option>
      <option value="Bank">Bank Transfer (+â‚±20)</option>
      <option value="COD">Cash on Delivery (COD)</option>
    </select>
    <div id="paymentDetails" class="small" style="margin-top:8px;"></div>
    <div style="margin-top:12px;">
      <button id="placeOrderBtn" class="btn">Place Order</button>
    </div>

    <h2>Order History & Tracking</h2>
    <table id="orderHistory">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Items</th>
          <th>Total</th>
          <th>Payment</th>
          <th>Status</th>
          <th>ETA</th>
          <th>Progress</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="refund">
    <h2>Refund Request</h2>
    <label>Order ID</label>
    <input id="refundOrderId" type="text" placeholder="Enter your Order ID">
    <label>Reason for Refund</label>
    <textarea id="refundReason" rows="3" placeholder="Describe the issue or reason"></textarea>
    <label>Refund Method</label>
    <select id="refundMethod">
      <option value="">Select method</option>
      <option>GCash</option>
      <option>Bank</option>
    </select>
    <div style="margin-top:12px;">
      <button id="refundBtn" class="btn">Submit Refund</button>
    </div>
    <div class="refund-confirm" id="refundConfirm">âœ… Refund request submitted! We'll contact you shortly.</div>
  </div>

  <div class="contact">
    <h2>Contact</h2>
    <p class="small">Email: support@ecofix.com â€¢ Phone: +63 912 345 6789</p>
  </div>
</div>

<!-- Receipt & Payment Modals (unchanged style) -->
<div class="modal-backdrop" id="paymentConfirmModal" role="dialog" aria-hidden="true">
  <div class="receipt" id="paymentConfirmContent">
    <h3>Confirm Payment</h3>
    <div class="meta" id="confirmMeta"></div>
    <div id="confirmItems"></div>
    <div id="confirmAmount" style="margin-top:8px;font-weight:800"></div>
    <div class="small" id="confirmFeeNote" style="color:#8a1f1f;margin-top:6px"></div>
    <div class="actions" style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button id="confirmCancelBtn" class="close-btn">Cancel</button>
      <button id="confirmPaymentBtn" class="print-btn">Confirm Payment</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="receiptModal" role="dialog" aria-hidden="true">
  <div class="receipt" id="receiptContent">
    <h3>EcoFix Receipt</h3>
    <div class="meta" id="receiptMeta"></div>
    <div><strong>Customer</strong><div id="rName" class="small"></div></div>
    <div style="margin-top:8px"><strong>Address</strong><div id="rAddress" class="small"></div></div>
    <table id="receiptItems" aria-hidden="false"></table>
    <div class="total" id="receiptTotal"></div>
    <div class="small" id="receiptFeeNote" style="margin-top:8px;color:#8a1f1f;"></div>
    <div class="actions">
      <button class="print-btn" onclick="printReceipt()">Print</button>
      <button class="close-btn" onclick="closeReceipt()">Close</button>
    </div>
  </div>
</div>

<!-- Chat -->
<div class="chat-fab" id="chatFab" title="Chat with EcoAssist">ðŸ’¬</div>
<div class="chat-panel" id="chatPanel" aria-hidden="true">
  <div class="chat-header">
    <div><strong>EcoAssist</strong><div class="small">Offline assistant</div></div>
    <div><button class="btn" id="closeChat" style="padding:6px 10px;border-radius:8px;background:#eee;color:#111">Close</button></div>
  </div>
  <div class="chat-body" id="chatBody"></div>
  <div class="chat-input">
    <input id="chatInput" type="text" placeholder="Ask about products, your order, or refunds..." style="flex:1;padding:10px;border:none;outline:none">
    <button id="chatSend" class="btn">Send</button>
  </div>
</div>

<script>
/* ---------- Config & Mock data ---------- */
const PAYMENT_FEES = { 'Gcash': 10, 'Bank': 20, 'COD': 0 };
const ETA_MIN_DAYS = 3, ETA_MAX_DAYS = 5;
const MOCK_RATINGS = {
  "Bamboo Reinforcement": { avg: 4.8, count: 132 },
  "Coconut Fiber Board": { avg: 4.5, count: 89 },
  "Fly Ash Concrete": { avg: 4.6, count: 210 },
  "Recycled Aggregates": { avg: 3.9, count: 47 }
};

/* ---------- State ---------- */
const cart = [], orders = [];

/* ---------- Helpers ---------- */
function generateOrderId(){ return 'ECO' + Date.now().toString(36).toUpperCase().slice(-8); }
function daysFromNow(n){ const d=new Date(); d.setDate(d.getDate()+n); return d.toLocaleDateString(); }
function formatETA(from,to){ return `${from} â€“ ${to}`; }

/* ---------- Cart handling ---------- */
const cartList = document.getElementById('cartList'), cartTotalEl = document.getElementById('cartTotal');
function addToCartFromBtn(btn){ const card = btn.closest('.product'); const name = card.dataset.name || card.querySelector('h3').innerText; const price = Number(card.dataset.price || card.querySelector('.price')?.innerText.replace(/[^0-9.-]+/g,"") || 0); addToCart(name, price); }
function addToCart(name, price){ const existing = cart.find(i=>i.name===name); if(existing) existing.qty++; else cart.push({name,price,qty:1}); renderCart(); addAIMessage(`EcoAssist: ${name} added to cart.`); }
function renderCart(){ cartList.innerHTML=''; let total=0; cart.forEach((it,idx)=>{ total+=it.price*it.qty; const li=document.createElement('li'); li.innerHTML=`<div style="flex:1"><strong>${it.name}</strong><div class="small">â‚±${it.price} x ${it.qty}</div></div><div style="display:flex;gap:8px;align-items:center"><button onclick="changeQty(${idx},-1)" style="padding:6px;border-radius:8px;border:1px solid #ddd;background:#fff">-</button><button onclick="changeQty(${idx},1)" style="padding:6px;border-radius:8px;border:1px solid #ddd;background:#fff">+</button><button onclick="removeItem(${idx})" style="padding:6px;border-radius:8px;border:1px solid #eee;background:#fff">Remove</button></div>`; li.style.display='flex'; li.style.justifyContent='space-between'; li.style.alignItems='center'; cartList.appendChild(li); }); cartTotalEl.innerText=`Total: â‚±${total}`; }
function changeQty(i,delta){ cart[i].qty=Math.max(1,cart[i].qty+delta); renderCart(); }
function removeItem(i){ cart.splice(i,1); renderCart(); }
document.querySelectorAll('.add-to-cart').forEach(btn=>btn.addEventListener('click',e=>addToCartFromBtn(e.target)));

/* ---------- Mock ratings UI ---------- */
function renderMockRatings(){ document.querySelectorAll('.mock-rating').forEach(el=>{ const product = el.dataset.product; const m = MOCK_RATINGS[product]; if(!m) return; el.innerHTML = `<span class="mock-stars">${'â˜…'.repeat(Math.round(m.avg))}</span> <span class="mock-meta">${m.avg.toFixed(1)} / 5 (${m.count} reviews)</span>`; }); }
function initUserRatings(){ document.querySelectorAll('.stars').forEach(container=>{ const product = container.dataset.product; container.innerHTML=''; const stored = Number(localStorage.getItem('rating_'+product) || 0); for(let i=1;i<=5;i++){ const span=document.createElement('span'); span.className='star'+(i<=stored?' active':''); span.innerHTML='â˜…'; span.addEventListener('click',()=>setUserRating(product,i,container)); container.appendChild(span); } const lbl=document.createElement('div'); lbl.className='small'; lbl.style.marginTop='6px'; lbl.textContent = stored ? `You: ${stored}/5` : 'You: Rate'; container.appendChild(lbl); }); }
function setUserRating(product,value,container){ localStorage.setItem('rating_'+product, value); const stars = container.querySelectorAll('.star'); stars.forEach((s,idx)=>s.classList.toggle('active', idx < value)); const lbl = container.querySelector('.small'); if(lbl) lbl.textContent = `You: ${value}/5 â€” Thanks for rating!`; addAIMessage(`EcoAssist: Thanks â€” you rated ${product} ${value}/5.`); }

/* ---------- Payment confirmation modal logic (with validation) ---------- */
const paymentConfirmModal = document.getElementById('paymentConfirmModal');
const confirmMeta = document.getElementById('confirmMeta');
const confirmItems = document.getElementById('confirmItems');
const confirmAmount = document.getElementById('confirmAmount');
const confirmFeeNote = document.getElementById('confirmFeeNote');
const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
const confirmCancelBtn = document.getElementById('confirmCancelBtn');
let pendingOrderPayload = null;

function openPaymentConfirmation(payload){
  pendingOrderPayload = payload;
  confirmMeta.innerText = `Confirm payment Â· ${new Date().toLocaleString()}`;
  confirmItems.innerHTML = '';
  payload.items.forEach(it=>{ const d=document.createElement('div'); d.className='small'; d.style.marginBottom='6px'; d.innerHTML = `<strong>${it.name}</strong> x ${it.qty} â€” â‚±${it.price*it.qty}`; confirmItems.appendChild(d); });
  confirmAmount.innerText = `Total to pay: â‚±${payload.total}`;
  confirmFeeNote.innerText = payload.fee>0 ? `Processing fee â‚±${payload.fee} is non-refundable if you cancel.` : '';
  paymentConfirmModal.style.display='flex';
}
confirmCancelBtn.addEventListener('click', ()=>{ pendingOrderPayload = null; paymentConfirmModal.style.display='none'; });
confirmPaymentBtn.addEventListener('click', ()=>{
  // final validation: ensure payment details input (if required) is correct length
  const paymentMethod = pendingOrderPayload?.payment || document.getElementById('custPayment').value;
  if(paymentMethod === 'Gcash'){
    const el = document.getElementById('gcashNumber');
    if(!el){ alert('Please enter payment details.'); return; }
    if(el.value.replace(/\D/g,'').length !== 11){ alert('Please enter a valid 11-digit GCash number.'); return; }
  } else if(paymentMethod === 'Bank'){
    const bankEl = document.getElementById('bankName');
    const accEl = document.getElementById('bankAccountNumber');
    if(!bankEl || !accEl){ alert('Please select your bank and enter account number.'); return; }
    const bank = bankEl.value;
    const lenReq = bank === 'BPI' ? 10 : bank === 'BDO' ? 12 : bank === 'Metrobank' ? 13 : null;
    const digits = accEl.value.replace(/\D/g,'');
    if(!lenReq || digits.length !== lenReq){ alert(`Please enter a valid ${lenReq}-digit account number for ${bank}.`); return; }
  }
  // proceed
  if(pendingOrderPayload) finalizeOrder(pendingOrderPayload);
  pendingOrderPayload = null;
  paymentConfirmModal.style.display='none';
});

/* ---------- Place order request (shows confirmation modal first) ---------- */
function placeOrderRequest(){
  const name = document.getElementById('custName').value.trim();
  const address = document.getElementById('custAddress').value.trim();
  const payment = document.getElementById('custPayment').value;
  if(!name || !address || !payment){ alert('Please complete name, address, and payment method.'); return; }
  if(cart.length===0){ alert('Your cart is empty.'); return; }
  const itemsCopy = cart.map(i=>({...i}));
  const subtotal = itemsCopy.reduce((s,it)=>s+it.price*it.qty,0);
  const fee = PAYMENT_FEES[payment] || 0;
  const total = subtotal + fee;
  const etaFrom = daysFromNow(ETA_MIN_DAYS), etaTo = daysFromNow(ETA_MAX_DAYS);
  // show confirm modal
  openPaymentConfirmation({ name, address, payment, items: itemsCopy, subtotal, fee, total, etaFrom, etaTo });
}
document.getElementById('placeOrderBtn').addEventListener('click', placeOrderRequest);

/* ---------- Finalize order after confirmation ---------- */
function finalizeOrder(payload){
  const id = generateOrderId(), date = new Date().toLocaleString();
  const order = { id, items: payload.items, subtotal: payload.subtotal, fee: payload.fee, total: payload.total, payment: payload.payment, status: (payload.payment==='COD'?'Pending':'Processing'), progress: (payload.payment==='COD'?0:5), etaFrom: payload.etaFrom, etaTo: payload.etaTo, _trackingInterval:null, cancelledAt:null, placedAt:date };
  orders.unshift(order); renderOrders();
  document.getElementById('receiptMeta').innerText = `Order #${id} Â· ${date} Â· ${payload.payment}`;
  document.getElementById('rName').innerText = payload.name;
  document.getElementById('rAddress').innerText = payload.address;
  receiptItems.innerHTML=''; payload.items.forEach(it=>{ const row=document.createElement('tr'); row.innerHTML=`<td style="text-align:left">${it.name} x ${it.qty}</td><td style="text-align:right">â‚±${it.price*it.qty}</td>`; receiptItems.appendChild(row); });
  receiptTotal.innerHTML = `<div class="small">Subtotal: â‚±${payload.subtotal}</div><div class="small">Payment fee: â‚±${payload.fee}</div><div class="total">Total: â‚±${payload.total}</div><div class="small">Estimated Delivery: ${formatETA(payload.etaFrom,payload.etaTo)}</div>`;
  document.getElementById('receiptFeeNote').innerText = payload.fee>0 ? `Note: Payment fee of â‚±${payload.fee} is a processing charge and is non-refundable if you cancel the order.` : '';
  document.getElementById('receiptModal').style.display='flex';
  cart.length=0; renderCart();
  document.getElementById('custName').value=''; document.getElementById('custAddress').value=''; document.getElementById('custPayment').value=''; document.getElementById('paymentDetails').innerHTML='';
}

/* ---------- Orders rendering & helpers ---------- */
const orderHistoryBody = document.querySelector('#orderHistory tbody');
function renderOrders(){ orderHistoryBody.innerHTML=''; orders.forEach((o,idx)=>{ const items=o.items.map(it=>`${it.name} x${it.qty}`).join(', '); const progId=`prog-${o.id}`; const actionParts=[]; if(o.status==='Pending') actionParts.push(`<button class="btn" onclick="markPaid(${idx})" style="padding:6px 8px;">Mark Paid</button>`); actionParts.push(`<button class="btn" onclick="startTracking(${idx})" style="padding:6px 8px;background:#1976d2">Track Delivery</button>`); if(isCancellable(o.status)) actionParts.push(`<button class="btn" onclick="cancelOrder(${idx})" style="padding:6px 8px;background:#f44336">Cancel</button>`); else actionParts.push(`<button class="btn" disabled style="padding:6px 8px;background:#eee;color:#666;cursor:not-allowed">Cancel</button>`); actionParts.push(`<button class="btn" onclick="openOrderDetails(${idx})" style="padding:6px 8px;background:#999">Details</button>`); const tr=document.createElement('tr'); tr.innerHTML = `<td>${o.id}</td><td>${items}</td><td>â‚±${o.total} ${o.fee>0?`<div class="small">fee: â‚±${o.fee}</div>`:''}</td><td>${o.payment}</td><td>${statusTagHTML(o.status)}</td><td>${formatETA(o.etaFrom,o.etaTo)}</td><td><div class="progress-wrap" title="${Math.round(o.progress||0)}%"><div id="${progId}" class="progress-bar" style="width:${o.progress||0}%"></div></div></td><td style="display:flex;gap:6px;flex-wrap:wrap">${actionParts.join('')}</td>`; orderHistoryBody.appendChild(tr); }); }
function statusTagHTML(status){ if(status==='Pending') return `<span class="status-tag status-pending">Pending</span>`; if(status==='Processing') return `<span class="status-tag status-processing">Processing</span>`; if(status==='Out for Delivery') return `<span class="status-tag status-out">Out for Delivery</span>`; if(status==='Delivered') return `<span class="status-tag status-delivered">Delivered</span>`; if(status==='Cancelled') return `<span class="status-tag status-cancelled">Cancelled</span>`; return `<span class="status-tag">${status}</span>`; }
function isCancellable(status){ return (status==='Pending' || status==='Processing'); }

/* ---------- markPaid, cancelOrder, details, tracking ---------- */
function markPaid(index){ const o=orders[index]; if(!o) return; if(o.status!=='Pending'){ alert('Order cannot be marked paid at this time.'); return;} o.status='Processing'; o.progress=5; renderOrders(); addAIMessage(`EcoAssist: Order ${o.id} marked as Paid â€” processing has started.`); }
function cancelOrder(index){ const o=orders[index]; if(!o) return; if(!isCancellable(o.status)){ alert('This order cannot be cancelled.'); return;} if(!confirm(`Cancel order ${o.id}? Note: payment fee of â‚±${o.fee} (if any) is non-refundable.`)) return; if(o._trackingInterval){ clearInterval(o._trackingInterval); o._trackingInterval=null; } o.status='Cancelled'; o.progress=0; o.cancelledAt=new Date().toLocaleString(); renderOrders(); addAIMessage(`EcoAssist: Order ${o.id} has been cancelled. Payment fee of â‚±${o.fee} is non-refundable and will be retained.`); }
function openOrderDetails(index){ const o=orders[index]; if(!o) return; document.getElementById('receiptModal').style.display='flex'; document.getElementById('receiptMeta').innerText=`Order #${o.id} Â· ${o.placedAt} Â· ${o.payment}`; document.getElementById('rName').innerText='(Order details)'; document.getElementById('rAddress').innerText=''; receiptItems.innerHTML=''; o.items.forEach(it=>{ const r=document.createElement('tr'); r.innerHTML=`<td>${it.name} x${it.qty}</td><td style="text-align:right">â‚±${it.price*it.qty}</td>`; receiptItems.appendChild(r); }); receiptTotal.innerHTML=`<div class="small">Subtotal: â‚±${o.subtotal}</div><div class="small">Processing fee: â‚±${o.fee}</div><div class="total">Total: â‚±${o.total}</div><div class="small">Estimated Delivery: ${formatETA(o.etaFrom,o.etaTo)}</div>${o.cancelledAt?`<div class="small" style="color:#8a1f1f">Cancelled at: ${o.cancelledAt}</div>`:''}`; document.getElementById('refundOrderId').value = o.id; }
function startTracking(index){ const order = orders[index]; if(!order) return; if(order.status==='Delivered'){ alert('Order already delivered.'); return; } if(order.status==='Cancelled'){ alert('Order was cancelled.'); return; } if(order.payment==='COD' && order.status==='Pending'){ if(!confirm('This order is COD and still Pending. Mark it as Paid now to start tracking?')) return; markPaid(index); } addAIMessage(`EcoAssist: Tracking started for order ${order.id}.`); const steps=[{status:'Processing',target:30},{status:'Out for Delivery',target:80},{status:'Delivered',target:100}]; let step=0; if(order._trackingInterval) clearInterval(order._trackingInterval); order._trackingInterval = setInterval(()=>{ if(order.status==='Cancelled'){ clearInterval(order._trackingInterval); order._trackingInterval=null; renderOrders(); return; } const currentStep = steps[step]; const increment=6; order.progress = Math.min((order.progress||0)+increment, currentStep.target); const bar = document.getElementById(`prog-${order.id}`); if(bar) bar.style.width = order.progress + '%'; if(order.progress >= currentStep.target){ order.status = currentStep.status; renderOrders(); addAIMessage(`EcoAssist: Order ${order.id} is now ${order.status}.`); step++; if(step>=steps.length){ if(order._trackingInterval){ clearInterval(order._trackingInterval); order._trackingInterval=null; } } } }, 1800); }

/* ---------- Refund ---------- */
document.getElementById('refundBtn').addEventListener('click', ()=>{ const id=document.getElementById('refundOrderId').value.trim(), reason=document.getElementById('refundReason').value.trim(), method=document.getElementById('refundMethod').value; if(!id||!reason||!method){ alert('Please provide Order ID, reason, and refund method.'); return; } document.getElementById('refundConfirm').style.display='block'; addAIMessage(`EcoAssist: Refund request for ${id} received (method: ${method}). Note: payment processing fees (if any) are non-refundable for cancelled orders.`); document.getElementById('refundOrderId').value=''; document.getElementById('refundReason').value=''; document.getElementById('refundMethod').value=''; setTimeout(()=>{ document.getElementById('refundConfirm').style.display='none'; },4000); });

/* ---------- Validation for payment number input ---------- */
/* Rules requested:
   - GCash only allow 11 digits
   - BPI allow 10 digits
   - BDO allow 12 digits
   - Metrobank allow 13 digits
   Implemented: live restriction, only digits, warning message, and final confirm check.
*/
function setupPaymentInputs(){
  // Called whenever paymentDetails innerHTML is updated. Attach listeners if inputs exist.
  // GCash input
  const gcash = document.getElementById('gcashNumber');
  if(gcash){
    const required = 11;
    attachDigitEnforcer(gcash, required, `Enter exactly ${required} digits for GCash`);
  }
  // Bank inputs: bankName select and bankAccountNumber
  const bankName = document.getElementById('bankName');
  const bankAcc = document.getElementById('bankAccountNumber');
  if(bankName && bankAcc){
    function updateBankRules(){
      const b = bankName.value;
      const len = b === 'BPI' ? 10 : b === 'BDO' ? 12 : b === 'Metrobank' ? 13 : null;
      bankAcc.placeholder = len ? `Enter ${len}-digit account number` : 'Account number';
      // re-attach
      attachDigitEnforcer(bankAcc, len, len ? `Enter exactly ${len} digits for ${b}` : 'Enter account number');
    }
    bankName.addEventListener('change', updateBankRules);
    updateBankRules();
  }
}

function attachDigitEnforcer(inputEl, requiredLen, warningText){
  // create or find warning span
  let warn = inputEl.parentElement.querySelector('.input-warning');
  if(!warn){
    warn = document.createElement('div'); warn.className='input-warning'; inputEl.parentElement.appendChild(warn);
  }
  warn.style.display = 'none';
  // ensure only digits allowed and block extra
  inputEl.addEventListener('input', ()=> {
    let digits = inputEl.value.replace(/\D/g,'');
    if(requiredLen) digits = digits.slice(0, requiredLen);
    const prev = inputEl.value;
    inputEl.value = digits;
    if(requiredLen){
      if(digits.length !== requiredLen){
        warn.textContent = `âš  ${warningText}`;
        warn.style.display = 'block';
      } else { warn.style.display = 'none'; }
    } else {
      // no fixed requirement; hide
      warn.style.display = 'none';
    }
  });
  // also prevent pasting non-digits or too long
  inputEl.addEventListener('paste', (e)=>{
    const paste = (e.clipboardData || window.clipboardData).getData('text') || '';
    const digits = paste.replace(/\D/g,'');
    if(requiredLen && digits.length > requiredLen){
      e.preventDefault();
      // paste only allowed portion
      const allowed = digits.slice(0, requiredLen);
      inputEl.value = allowed;
      const warn = inputEl.parentElement.querySelector('.input-warning');
      if(warn){ warn.textContent = `âš  ${warningText}`; warn.style.display = allowed.length === requiredLen ? 'none' : 'block'; }
    }
  });
}

/* ---------- AI Assistant (product suggestions included) ---------- */
const chatBody = document.getElementById('chatBody'), chatInput = document.getElementById('chatInput'), chatSendBtn = document.getElementById('chatSend');
document.getElementById('chatFab').addEventListener('click', ()=>{ document.getElementById('chatPanel').style.display='flex'; chatInput.focus(); });
document.getElementById('closeChat').addEventListener('click', ()=>{ document.getElementById('chatPanel').style.display='none'; });

function appendChatBubble(role, text){
  const div=document.createElement('div'); div.className='bubble '+(role==='user'?'user':'ai'); div.textContent=text; chatBody.appendChild(div); chatBody.scrollTop=chatBody.scrollHeight;
}
function appendChatHTML(role, html){
  const div=document.createElement('div'); div.className='bubble '+(role==='user'?'user':'ai'); div.innerHTML=html; chatBody.appendChild(div); chatBody.scrollTop=chatBody.scrollHeight;
}
function addAIProductSuggestion(productName){
  const prodEl = Array.from(document.querySelectorAll('.product')).find(p => p.dataset.name === productName);
  if(!prodEl){ appendChatBubble('ai', `I recommend ${productName}.`); return; }
  const img = prodEl.querySelector('img')?.src || '';
  const price = prodEl.dataset.price || prodEl.querySelector('.price')?.innerText || '';
  const desc = prodEl.dataset.desc || prodEl.querySelector('p')?.innerText || '';
  const html = `<div class="chat-card"><img src="${img}" alt="${productName}"><div class="info"><div style="font-weight:700">${productName}</div><div class="small">${desc}</div><div style="margin-top:6px;font-weight:700">â‚±${price}</div><div style="margin-top:8px"><button class="btn" onclick="addToCart('${productName}', ${Number(price)})">Add to Cart</button></div></div></div>`;
  appendChatHTML('ai', html);
}
function aiReplyAndSuggest(text){
  const t = text.toLowerCase();
  if(t.includes('crack') || t.includes('seal') || (t.includes('wall') && t.includes('repair'))){ appendChatBubble('ai','For wall cracks and sealing I recommend Fly Ash Concrete â€” sustainable and strong. Hereâ€™s a quick product card:'); addAIProductSuggestion('Fly Ash Concrete'); return; }
  if(t.includes('bamboo') || t.includes('wood') || t.includes('reinforcement')){ appendChatBubble('ai','For renewable reinforcement you can use Bamboo Reinforcement. Quick look:'); addAIProductSuggestion('Bamboo Reinforcement'); return; }
  if(t.includes('insul') || t.includes('insulation') || t.includes('warm') || t.includes('hot')){ appendChatBubble('ai','Coconut Fiber Board is great for insulation and finishing â€” check it out:'); addAIProductSuggestion('Coconut Fiber Board'); return; }
  if(t.includes('aggregate') || t.includes('base') || t.includes('fill')){ appendChatBubble('ai','Recycled Aggregates are ideal for sub-base layers and general fill:'); addAIProductSuggestion('Recycled Aggregates'); return; }
  // fallbacks
  if(t.includes('price')||t.includes('cost')) appendChatBubble('ai','Prices: Bamboo â‚±250, Coconut Fiber Board â‚±300, Fly Ash Concrete â‚±220, Recycled Aggregates â‚±180. Payment fees: GCash â‚±10, Bank â‚±20, COD â‚±0.');
  else if(t.includes('refund')) appendChatBubble('ai','Refunds: use the Refund section. Payment processing fees are non-refundable if the order is cancelled.');
  else if(t.includes('track')||t.includes('status')) appendChatBubble('ai','Open Order History and click "Track Delivery" for live progress updates; ETA appears in the ETA column.');
  else if(t.includes('eta')||t.includes('delivery')) appendChatBubble('ai','ETA is shown on the receipt and Order History (typically 3â€“5 days after order).');
  else if(t.includes('confirm')||t.includes('payment')) appendChatBubble('ai','After clicking Place Order you will see a confirmation popup summarizing total (including fees). Confirm to finalize payment.');
  else if(t.includes('rating')||t.includes('rate')) appendChatBubble('ai','Mock community ratings appear under the product name; you can add your personal rating with the stars.');
  else if(t.includes('cancel')) appendChatBubble('ai','To cancel an order, go to Order History and click Cancel on orders marked Pending or Processing. Fees may be non-refundable.');
  else if(t.includes('order')) appendChatBubble('ai','Place your order using Checkout â€” receipts with Order ID, ETA and fee details appear after confirmation.');
  else if(t.includes('hello')||t.includes('hi')) appendChatBubble('ai',"Hi! I'm EcoAssist â€” I can help with product info, fees, ratings, and order tracking.");
  else appendChatBubble('ai','I can help with product info, orders, fees, ETA, ratings, and refunds â€” try "repair", "insulation", "bamboo", "track my order", or ask about fees.');
}
chatSend.addEventListener('click', ()=>{ const txt = chatInput.value.trim(); if(!txt) return; appendChatBubble('user', txt); chatInput.value=''; const typing=document.createElement('div'); typing.id='typingDots'; typing.innerHTML='<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>'; chatBody.appendChild(typing); chatBody.scrollTop=chatBody.scrollHeight; setTimeout(()=>{ const dots=document.getElementById('typingDots'); if(dots) dots.remove(); aiReplyAndSuggest(txt); },700); });

/* ---------- Misc: Print / close receipt ---------- */
function closeReceipt(){ document.getElementById('receiptModal').style.display='none'; }
function printReceipt(){ const content=document.getElementById('receiptContent').innerHTML; const w=window.open('','_blank','width=600,height=700'); w.document.write(`<html><head><title>Receipt</title></head><body>${content}</body></html>`); w.document.close(); w.focus(); setTimeout(()=>w.print(),300); }

/* ---------- Init UI rendering ---------- */
function initAll(){ renderCart(); renderOrders(); renderMockRatings(); initUserRatings(); setupPaymentFieldObserver(); }
initAll();

/* ---------- Payment fields dynamic injection observer & validation setup ---------- */
// We need to wire up validation whenever paymentDetails content changes (because we inject different inputs)
// Add a MutationObserver on paymentDetails to run setupPaymentInputs() and attach validators to newly created inputs
function setupPaymentFieldObserver(){
  const paymentDetailsEl = document.getElementById('paymentDetails');
  // on change of the select, we will set innerHTML accordingly (existing code uses change event)
  document.getElementById('custPayment').addEventListener('change', (e)=>{
    const choice = e.target.value;
    paymentDetailsEl.innerHTML = '';
    if(choice === 'Gcash'){
      paymentDetailsEl.innerHTML = `<div class="small">Processing fee: â‚±${PAYMENT_FEES['Gcash']} (non-refundable on cancel)</div>
        <label class="small">Enter payment details</label>
        <input id="gcashNumber" placeholder="Enter 11-digit GCash number">`;
      // attach validator
      setTimeout(()=> attachDigitEnforcer(document.getElementById('gcashNumber'), 11, 'Enter exactly 11 digits for GCash'), 0);
    } else if(choice === 'Bank'){
      paymentDetailsEl.innerHTML = `<div class="small">Processing fee: â‚±${PAYMENT_FEES['Bank']} (non-refundable on cancel)</div>
        <label class="small">Select Bank</label>
        <select id="bankName" style="width:100%;padding:10px;border-radius:10px;border:1px solid #d9d9d9;margin-top:8px">
          <option value="">-- Choose Bank --</option>
          <option value="BDO">BDO</option>
          <option value="BPI">BPI</option>
          <option value="Metrobank">Metrobank</option>
        </select>
        <label class="small" style="margin-top:10px;display:block;"><b>Enter Account Number:</b></label>
        <input id="bankAccountNumber" placeholder="Enter account number" style="width:100%;padding:10px;border-radius:10px;border:1px solid #d9d9d9;margin-top:8px">`;
      // attach listeners to bank name and account after short delay to ensure elements exist
      setTimeout(()=>{
        const bankName = document.getElementById('bankName');
        const bankAcc = document.getElementById('bankAccountNumber');
        function updateBankRules(){
          const b = bankName.value;
          const len = b === 'BPI' ? 10 : b === 'BDO' ? 12 : b === 'Metrobank' ? 13 : null;
          bankAcc.placeholder = len ? `Enter ${len}-digit account number` : 'Enter account number';
          attachDigitEnforcer(bankAcc, len, len ? `Enter exactly ${len} digits for ${b}` : 'Enter account number');
        }
        bankName.addEventListener('change', updateBankRules);
        updateBankRules();
      }, 0);
    } else if(choice === 'COD'){
      paymentDetailsEl.innerHTML = `<div class="small">No processing fee for COD.</div>`;
    } else {
      paymentDetailsEl.innerHTML = '';
    }
  });
}

/* ---------- attachDigitEnforcer utility (global) ---------- */
function attachDigitEnforcer(inputEl, requiredLen, warningText){
  if(!inputEl) return;
  // remove existing listener by cloning if desired to avoid duplicates
  const newInput = inputEl.cloneNode(true);
  inputEl.parentElement.replaceChild(newInput, inputEl);
  inputEl = newInput;
  let warn = inputEl.parentElement.querySelector('.input-warning');
  if(!warn){ warn = document.createElement('div'); warn.className='input-warning'; inputEl.parentElement.appendChild(warn); }
  warn.style.display = 'none';
  inputEl.addEventListener('input', ()=>{
    let digits = inputEl.value.replace(/\D/g,'');
    if(requiredLen) digits = digits.slice(0, requiredLen);
    inputEl.value = digits;
    if(requiredLen){
      if(digits.length !== requiredLen){ warn.textContent = `âš  ${warningText}`; warn.style.display = 'block'; }
      else { warn.style.display = 'none'; }
    } else { warn.style.display = 'none'; }
  });
  inputEl.addEventListener('paste', (e)=>{
    const paste = (e.clipboardData||window.clipboardData).getData('text')||'';
    const digits = paste.replace(/\D/g,'');
    if(requiredLen && digits.length > requiredLen){
      e.preventDefault();
      const allowed = digits.slice(0, requiredLen);
      inputEl.value = allowed;
      warn.textContent = `âš  ${warningText}`; warn.style.display = allowed.length===requiredLen ? 'none' : 'block';
    }
  });
}

/* ---------- Utility: AI messages ---------- */
function addAIMessage(text){ document.getElementById('chatPanel').style.display = 'flex'; const div=document.createElement('div'); div.className='bubble ai'; div.textContent=text; document.getElementById('chatBody').appendChild(div); document.getElementById('chatBody').scrollTop = document.getElementById('chatBody').scrollHeight; }

/* ---------- Misc print / close ---------- */
function closeReceipt(){ document.getElementById('receiptModal').style.display='none'; }
function printReceipt(){ const content=document.getElementById('receiptContent').innerHTML; const w=window.open('','_blank','width=600,height=700'); w.document.write(`<html><head><title>Receipt</title></head><body>${content}</body></html>`); w.document.close(); w.focus(); setTimeout(()=>w.print(),300); }

</script>
</body>
</html>
