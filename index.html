<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EcoFix â€“ Sustainable Repair Solutions</title>
<style>
  :root{--green:#2e7d32;--green-dark:#236127;--accent:#43a047;--bg:#f0f8f5;--muted:#666;}
  body{font-family:"Poppins",Arial,sans-serif;margin:0;background:var(--bg);color:#222;}
  header{display:flex;align-items:center;gap:15px;justify-content:center;background:var(--green);color:#fff;padding:18px;}
  header img{width:60px;height:60px;border-radius:10px;object-fit:cover}
  header h1{margin:0;font-size:1.25rem;}
  .container{max-width:1000px;margin:22px auto;padding:0 18px;}
  .overview{background:#e8f5e9;padding:18px;border-radius:12px;margin-bottom:20px;}
  h2{color:var(--green);margin-top:0}
  .products{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:18px;}
  .product{background:#fff;border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);text-align:center;transition:transform .18s ease,box-shadow .18s;}
  .product:hover{transform:translateY(-6px);box-shadow:0 14px 30px rgba(0,0,0,0.08);}
  .product img{width:100%;height:170px;object-fit:cover;border-radius:10px}
  .product h3{margin:10px 0 6px;color:var(--green-dark)}
  .product p{margin:0 0 10px;color:var(--muted);font-size:.95rem}
  .product .price{font-weight:700;color:#111;margin-bottom:8px}
  .btn{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:600;transition:transform .12s,background .12s}
  .btn:hover{transform:scale(1.03);background:var(--green-dark)}
  .cart{background:#f6fff6;padding:14px;border-radius:12px;margin-top:20px}
  #cartList{list-style:none;padding-left:0;margin:0}
  #cartList li{padding:8px 0;border-bottom:1px dashed #e1e1e1;display:flex;justify-content:space-between;align-items:center}
  #cartList li:last-child{border-bottom:none}
  .small{font-size:.9rem;color:var(--muted)}
  .checkout{background:#eaf7ea;padding:16px;border-radius:12px;margin-top:18px}
  .checkout input,.checkout select{width:100%;padding:10px;border-radius:10px;border:1px solid #d9d9d9;margin-top:8px}
  .contact{background:#e8f5e9;padding:16px;border-radius:12px;margin-top:18px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  table th,table td{border:1px solid #e1e1e1;padding:8px;text-align:left;font-size:14px}
  .progress-wrap{background:#eee;border-radius:8px;height:12px;overflow:hidden;width:120px}
  .progress-bar{height:100%;width:0%;background:linear-gradient(90deg,#4caf50,#8bc34a);transition:width .4s linear}
  .status-tag{padding:6px 8px;border-radius:6px;font-weight:600}
  .status-pending{background:#fff4e5;color:#8a5300}
  .status-processing{background:#fff9e6;color:#7a5b00}
  .status-out{background:#e6f7ff;color:#025f8a}
  .status-delivered{background:#e8f5e9;color:#155724}
  .status-cancelled{background:#ffeceb;color:#8a1f1f}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
  .receipt{width:360px;background:#fff;border-radius:12px;padding:18px;box-shadow:0 20px 50px rgba(0,0,0,0.3);font-size:14px}
  .refund{background:#f0fff0;padding:16px;border-radius:12px;margin-top:18px}
  .refund input,.refund textarea,.refund select{width:100%;padding:10px;border-radius:10px;border:1px solid #d9d9d9;margin-top:8px}
  .refund-confirm{background:#dff0d8;color:#2e7d32;padding:8px;border-radius:8px;margin-top:10px;display:none}
  .chat-fab{position:fixed;right:22px;bottom:22px;width:64px;height:64px;border-radius:18px;background:linear-gradient(180deg,var(--accent),#06b6d4);display:flex;align-items:center;justify-content:center;color:#fff;font-size:22px;cursor:pointer;box-shadow:0 12px 30px rgba(2,6,23,0.4);z-index:999}
  .chat-panel{position:fixed;right:22px;bottom:100px;width:340px;max-height:68vh;background:var(--card);border-radius:14px;box-shadow:0 12px 36px rgba(2,6,23,0.35);display:none;flex-direction:column;overflow:hidden;z-index:999}
  .chat-header{padding:12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(90deg,#f6fff6,#ffffff)}
  .chat-body{padding:12px;flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;background:#fbfffb}
  .chat-input{display:flex;border-top:1px solid #eee;padding:8px;gap:8px}
  .bubble{display:inline-block;padding:8px 12px;border-radius:12px;max-width:84%}
  .bubble.user{background:var(--accent);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
  .bubble.ai{background:#f1f1f1;color:#111;align-self:flex-start;border-bottom-left-radius:4px}
  @media (max-width:600px){ .chat-panel{right:12px;left:12px;width:auto} .receipt{width:92vw} }
</style>
</head>
<body>

<header>
  <img src="logo.png" alt="EcoFix Logo" onerror="this.src='https://via.placeholder.com/80x80?text=EcoFix'">
  <h1>EcoFix â€“ Sustainable Repair Solutions</h1>
</header>

<div class="container">
  <div class="overview">
    <h2>Company Overview</h2>
    <p><strong>EcoFix</strong> provides green repair materials like bamboo, coconut fiber, fly ash concrete, and recycled aggregates for sustainable construction.</p>
  </div>

  <h2>Products</h2>
  <div class="products" id="products">
    <div class="product" data-name="Bamboo Reinforcement" data-price="250">
      <img src="bamboo.jpg" alt="Bamboo Reinforcement" onerror="this.src='https://via.placeholder.com/400x300?text=Bamboo'">
      <h3>Bamboo Reinforcement</h3>
      <p class="small">Strong, renewable, ideal for lightweight structural repairs.</p>
      <div class="price">â‚±250</div>
      <button class="btn add-to-cart">Add to Cart</button>
    </div>

    <div class="product" data-name="Coconut Fiber Board" data-price="300">
      <img src="coco.jpg" alt="Coconut Fiber Board" onerror="this.src='https://via.placeholder.com/400x300?text=Coconut+Fiber'">
      <h3>Coconut Fiber Board</h3>
      <p class="small">Insulation and finishing boards from coconut husk fiber.</p>
      <div class="price">â‚±300</div>
      <button class="btn add-to-cart">Add to Cart</button>
    </div>

    <div class="product" data-name="Fly Ash Concrete" data-price="220">
      <img src="flyash.jpg" alt="Fly Ash Concrete" onerror="this.src='https://via.placeholder.com/400x300?text=Fly+Ash'">
      <h3>Fly Ash Concrete</h3>
      <p class="small">Low-carbon concrete using industrial by-products for strength.</p>
      <div class="price">â‚±220</div>
      <button class="btn add-to-cart">Add to Cart</button>
    </div>

    <div class="product" data-name="Recycled Aggregates" data-price="180">
      <img src="aggregate.jpg" alt="Recycled Aggregates" onerror="this.src='https://via.placeholder.com/400x300?text=Aggregates'">
      <h3>Recycled Aggregates</h3>
      <p class="small">Processed construction debris reused for new builds.</p>
      <div class="price">â‚±180</div>
      <button class="btn add-to-cart">Add to Cart</button>
    </div>
  </div>

  <div class="cart">
    <h2>Cart</h2>
    <ul id="cartList"></ul>
    <div class="small">Tip: You can change quantity in the cart before checkout.</div>
    <h3 id="cartTotal">Total: â‚±0</h3>
  </div>

  <div class="checkout">
    <h2>Checkout</h2>
    <label>Full name</label>
    <input id="custName" type="text" placeholder="Your full name">
    <label>Delivery address</label>
    <input id="custAddress" type="text" placeholder="Complete address">
    <label>Mode of payment</label>
    <select id="custPayment">
      <option value="">Select payment</option>
      <option value="Gcash">GCash (+â‚±10)</option>
      <option value="Bank">Bank Transfer (+â‚±20)</option>
      <option value="COD">Cash on Delivery (COD)</option>
    </select>
    <div id="paymentDetails" class="small" style="margin-top:8px;"></div>
    <div style="margin-top:12px;">
      <button id="placeOrderBtn" class="btn">Place Order</button>
    </div>

    <h2>Order History & Tracking</h2>
    <table id="orderHistory">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Items</th>
          <th>Total</th>
          <th>Payment</th>
          <th>Status</th>
          <th>ETA</th>
          <th>Progress</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="refund">
    <h2>Refund Request</h2>
    <label>Order ID</label>
    <input id="refundOrderId" type="text" placeholder="Enter your Order ID">
    <label>Reason for Refund</label>
    <textarea id="refundReason" rows="3" placeholder="Describe the issue or reason"></textarea>
    <label>Refund Method</label>
    <select id="refundMethod">
      <option value="">Select method</option>
      <option>GCash</option>
      <option>Bank</option>
      <option>Store Credit</option>
    </select>
    <div style="margin-top:12px;">
      <button id="refundBtn" class="btn">Submit Refund</button>
    </div>
    <div class="refund-confirm" id="refundConfirm">âœ… Refund request submitted! We'll contact you shortly.</div>
  </div>

  <div class="contact">
    <h2>Contact</h2>
    <p class="small">Email: support@ecofix.com â€¢ Phone: +63 912 345 6789</p>
  </div>
</div>

<!-- Receipt Modal -->
<div class="modal-backdrop" id="receiptModal" role="dialog" aria-hidden="true">
  <div class="receipt" id="receiptContent">
    <h3>EcoFix Receipt</h3>
    <div class="meta" id="receiptMeta"></div>
    <div><strong>Customer</strong><div id="rName" class="small"></div></div>
    <div style="margin-top:8px"><strong>Address</strong><div id="rAddress" class="small"></div></div>
    <table id="receiptItems" aria-hidden="false"></table>
    <div class="total" id="receiptTotal"></div>
    <div class="small" id="receiptFeeNote" style="margin-top:8px;color:#8a1f1f;"></div>
    <div class="actions">
      <button class="print-btn" onclick="printReceipt()">Print</button>
      <button class="close-btn" onclick="closeReceipt()">Close</button>
    </div>
  </div>
</div>

<!-- Chat Floating Button + Panel -->
<div class="chat-fab" id="chatFab" title="Chat with EcoAssist">ðŸ’¬</div>
<div class="chat-panel" id="chatPanel" aria-hidden="true">
  <div class="chat-header">
    <div><strong>EcoAssist</strong><div class="small">Offline assistant</div></div>
    <div><button class="btn" id="closeChat" style="padding:6px 10px;border-radius:8px;background:#eee;color:#111">Close</button></div>
  </div>
  <div class="chat-body" id="chatBody"></div>
  <div class="chat-input">
    <input id="chatInput" type="text" placeholder="Ask about products, your order, or refunds..." style="flex:1;padding:10px;border:none;outline:none">
    <button id="chatSend" class="btn">Send</button>
  </div>
</div>

<script>
/* ---------- Config (fees & ETA window) ---------- */
const PAYMENT_FEES = { 'Gcash': 10, 'Bank': 20, 'COD': 0 };
const ETA_MIN_DAYS = 3;
const ETA_MAX_DAYS = 5;

/* ---------- Data stores ---------- */
const cart = []; // {name,price,qty}
const orders = []; // {id, items, total, payment, status, progress, fee, etaFrom, etaTo, _trackingInterval, cancelledAt}

/* ---------- Cart logic ---------- */
const cartList = document.getElementById('cartList');
const cartTotalEl = document.getElementById('cartTotal');

function addToCartFromBtn(btn){
  const card = btn.closest('.product');
  const name = card.dataset.name || card.querySelector('h3').innerText;
  const price = Number(card.dataset.price || card.querySelector('.price')?.innerText.replace(/[^0-9.-]+/g,"") || 0);
  addToCart(name, price);
}
function addToCart(name, price){
  const existing = cart.find(i => i.name === name);
  if(existing) existing.qty++;
  else cart.push({name, price, qty:1});
  renderCart();
}
function renderCart(){
  cartList.innerHTML = '';
  let total = 0;
  cart.forEach((it, idx) => {
    total += it.price * it.qty;
    const li = document.createElement('li');
    li.innerHTML = `
      <div style="flex:1">
        <strong>${it.name}</strong><div class="small">â‚±${it.price} x ${it.qty}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button onclick="changeQty(${idx},-1)" style="padding:6px;border-radius:8px;border:1px solid #ddd;background:#fff">-</button>
        <button onclick="changeQty(${idx},1)" style="padding:6px;border-radius:8px;border:1px solid #ddd;background:#fff">+</button>
        <button onclick="removeItem(${idx})" style="padding:6px;border-radius:8px;border:1px solid #eee;background:#fff">Remove</button>
      </div>`;
    li.style.display = 'flex';
    li.style.justifyContent = 'space-between';
    li.style.alignItems = 'center';
    cartList.appendChild(li);
  });
  cartTotalEl.innerText = `Total: â‚±${total}`;
}
function changeQty(i, delta){ cart[i].qty = Math.max(1, cart[i].qty + delta); renderCart(); }
function removeItem(i){ cart.splice(i,1); renderCart(); }
document.querySelectorAll('.add-to-cart').forEach(btn => btn.addEventListener('click', (e) => { addToCartFromBtn(e.target); }));

/* ---------- Helpers ---------- */
function generateOrderId(){ return 'ECO' + Date.now().toString(36).toUpperCase().slice(-8); }
function daysFromNow(n){
  const d = new Date();
  d.setDate(d.getDate() + n);
  return d.toLocaleDateString();
}
function formatETA(from, to){ return `${from} â€“ ${to}`; }

/* ---------- Checkout & Orders ---------- */
const receiptModal = document.getElementById('receiptModal');
const receiptMeta = document.getElementById('receiptMeta');
const rName = document.getElementById('rName');
const rAddress = document.getElementById('rAddress');
const receiptItems = document.getElementById('receiptItems');
const receiptTotal = document.getElementById('receiptTotal');
const receiptFeeNote = document.getElementById('receiptFeeNote');
const orderHistoryBody = document.querySelector('#orderHistory tbody');

function placeOrder(){
  const name = document.getElementById('custName').value.trim();
  const address = document.getElementById('custAddress').value.trim();
  const payment = document.getElementById('custPayment').value;
  if(!name || !address || !payment){ alert('Please complete name, address, and payment method.'); return; }
  if(cart.length === 0){ alert('Your cart is empty.'); return; }

  const id = generateOrderId();
  const date = new Date().toLocaleString();
  const itemsCopy = cart.map(i => ({...i}));
  const subtotal = itemsCopy.reduce((s,it)=>s + it.price * it.qty, 0);
  const fee = PAYMENT_FEES[payment] || 0;
  const total = subtotal + fee;

  // ETA calculation (3-5 days)
  const etaFrom = daysFromNow(ETA_MIN_DAYS);
  const etaTo = daysFromNow(ETA_MAX_DAYS);

  // initial status
  const status = (payment === 'COD') ? 'Pending' : 'Processing';
  const order = { id, items: itemsCopy, subtotal, fee, total, payment, status, progress: (status==='Processing'?5:0), etaFrom, etaTo, _trackingInterval: null, cancelledAt: null, placedAt: date };
  orders.unshift(order);
  renderOrders();

  // Show receipt
  receiptMeta.innerText = `Order #${id} Â· ${date} Â· ${payment}`;
  rName.innerText = name;
  rAddress.innerText = address;
  receiptItems.innerHTML = '';
  itemsCopy.forEach(it => {
    const row = document.createElement('tr');
    row.innerHTML = `<td style="text-align:left">${it.name} x ${it.qty}</td><td style="text-align:right">â‚±${it.price*it.qty}</td>`;
    receiptItems.appendChild(row);
  });
  receiptTotal.innerHTML = `<div class="small">Subtotal: â‚±${subtotal}</div><div class="small">Payment fee: â‚±${fee}</div><div class="total">Total: â‚±${total}</div><div class="small">Estimated Delivery: ${formatETA(etaFrom, etaTo)}</div>`;
  receiptFeeNote.innerText = fee>0 ? `Note: Payment fee of â‚±${fee} is a processing charge and is non-refundable if you cancel the order.` : '';
  receiptModal.style.display = 'flex';

  // Clear cart & fields
  cart.length = 0;
  renderCart();
  document.getElementById('custName').value = '';
  document.getElementById('custAddress').value = '';
  document.getElementById('custPayment').value = '';
  document.getElementById('paymentDetails').innerHTML = '';
}
document.getElementById('placeOrderBtn').addEventListener('click', placeOrder);

function closeReceipt(){ receiptModal.style.display = 'none'; }
function printReceipt(){
  const content = document.getElementById('receiptContent').innerHTML;
  const w = window.open('','_blank','width=600,height=700');
  w.document.write(`<html><head><title>Receipt</title></head><body>${content}</body></html>`);
  w.document.close(); w.focus(); setTimeout(()=> w.print(),300);
}

/* ---------- Order History Rendering ---------- */
function statusTagHTML(status){
  if(status==='Pending') return `<span class="status-tag status-pending">Pending</span>`;
  if(status==='Processing') return `<span class="status-tag status-processing">Processing</span>`;
  if(status==='Out for Delivery') return `<span class="status-tag status-out">Out for Delivery</span>`;
  if(status==='Delivered') return `<span class="status-tag status-delivered">Delivered</span>`;
  if(status==='Cancelled') return `<span class="status-tag status-cancelled">Cancelled</span>`;
  return `<span class="status-tag">${status}</span>`;
}

function isCancellable(status){
  return (status === 'Pending' || status === 'Processing');
}

function renderOrders(){
  orderHistoryBody.innerHTML = '';
  orders.forEach((o, idx) => {
    const items = o.items.map(it => `${it.name} x${it.qty}`).join(', ');
    const progId = `prog-${o.id}`;
    // Actions: Mark Paid (Pending); Track; Cancel (allowed for Pending/Processing); Details
    const actionParts = [];
    if(o.status === 'Pending'){
      actionParts.push(`<button class="btn" onclick="markPaid(${idx})" style="padding:6px 8px;">Mark Paid</button>`);
    }
    actionParts.push(`<button class="btn" onclick="startTracking(${idx})" style="padding:6px 8px;background:#1976d2">Track Delivery</button>`);
    if(isCancellable(o.status)){
      actionParts.push(`<button class="btn" onclick="cancelOrder(${idx})" style="padding:6px 8px;background:#f44336">Cancel</button>`);
    } else {
      actionParts.push(`<button class="btn" disabled style="padding:6px 8px;background:#eee;color:#666;cursor:not-allowed">Cancel</button>`);
    }
    actionParts.push(`<button class="btn" onclick="openOrderDetails(${idx})" style="padding:6px 8px;background:#999">Details</button>`);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${o.id}</td>
      <td>${items}</td>
      <td>â‚±${o.total} ${o.fee>0?`<div class="small">fee: â‚±${o.fee}</div>`:''}</td>
      <td>${o.payment}</td>
      <td>${statusTagHTML(o.status)}</td>
      <td>${formatETA(o.etaFrom, o.etaTo)}</td>
      <td>
        <div class="progress-wrap" title="${Math.round(o.progress || 0)}%">
          <div id="${progId}" class="progress-bar" style="width:${o.progress || 0}%"></div>
        </div>
      </td>
      <td style="display:flex;gap:6px;flex-wrap:wrap">${actionParts.join('')}</td>
    `;
    orderHistoryBody.appendChild(tr);
  });
}

/* ---------- Mark paid ---------- */
function markPaid(index){
  const o = orders[index];
  if(!o) return;
  if(o.status !== 'Pending'){ alert('Order cannot be marked paid at this time.'); return; }
  o.status = 'Processing';
  o.progress = 5;
  renderOrders();
  addAIMessage(`EcoAssist: Order ${o.id} marked as Paid â€” processing has started.`);
}

/* ---------- Cancel order (Order History only) ---------- */
function cancelOrder(index){
  const o = orders[index];
  if(!o) return;
  if(!isCancellable(o.status)){ alert('This order cannot be cancelled.'); return; }
  if(!confirm(`Cancel order ${o.id}? Note: payment processing fee of â‚±${o.fee} (if any) is non-refundable.`)) return;

  // Stop tracking if active
  if(o._trackingInterval){ clearInterval(o._trackingInterval); o._trackingInterval = null; }
  o.status = 'Cancelled';
  o.progress = 0;
  o.cancelledAt = new Date().toLocaleString();
  renderOrders();
  addAIMessage(`EcoAssist: Order ${o.id} has been cancelled. Payment fee of â‚±${o.fee} is non-refundable and will be retained.`);
}

/* ---------- Order details (receipt-like) ---------- */
function openOrderDetails(index){
  const o = orders[index];
  if(!o) return;
  receiptModal.style.display = 'flex';
  receiptMeta.innerText = `Order #${o.id} Â· ${o.placedAt} Â· ${o.payment}`;
  rName.innerText = '(Order history)';
  rAddress.innerText = '';
  receiptItems.innerHTML = '';
  o.items.forEach(it => {
    const r = document.createElement('tr');
    r.innerHTML = `<td>${it.name} x${it.qty}</td><td style="text-align:right">â‚±${it.price*it.qty}</td>`;
    receiptItems.appendChild(r);
  });
  receiptTotal.innerHTML = `<div class="small">Subtotal: â‚±${o.subtotal}</div><div class="small">Processing fee: â‚±${o.fee}</div><div class="total">Total: â‚±${o.total}</div><div class="small">Estimated Delivery: ${formatETA(o.etaFrom, o.etaTo)}</div>`;
  receiptFeeNote.innerText = o.fee>0 ? `Note: Payment fee of â‚±${o.fee} is non-refundable if you cancel.` : '';
  // prefill refund order id field if needed
  document.getElementById('refundOrderId').value = o.id;
}

/* ---------- Tracking simulation (auto-update) ---------- */
function startTracking(index){
  const order = orders[index];
  if(!order) return;
  if(order.status === 'Delivered'){ alert('Order already delivered.'); return; }
  if(order.status === 'Cancelled'){ alert('Order was cancelled.'); return; }

  // If COD and still Pending, ask to mark paid
  if(order.payment === 'COD' && order.status === 'Pending'){
    if(!confirm('Order is COD and still Pending. Mark as Paid now to start tracking?')) return;
    markPaid(index);
  }

  addAIMessage(`EcoAssist: Tracking started for order ${order.id}.`);
  const steps = [
    {status: 'Processing', target: 30},
    {status: 'Out for Delivery', target: 80},
    {status: 'Delivered', target: 100}
  ];
  let step = 0;
  if(order._trackingInterval) clearInterval(order._trackingInterval);

  order._trackingInterval = setInterval(() => {
    if(order.status === 'Cancelled'){
      clearInterval(order._trackingInterval); order._trackingInterval = null; renderOrders(); return;
    }
    const currentStep = steps[step];
    const increment = 6;
    order.progress = Math.min((order.progress || 0) + increment, currentStep.target);
    const bar = document.getElementById(`prog-${order.id}`);
    if(bar) bar.style.width = order.progress + '%';
    if(order.progress >= currentStep.target){
      order.status = currentStep.status;
      renderOrders();
      addAIMessage(`EcoAssist: Order ${order.id} is now ${order.status}.`);
      step++;
      if(step >= steps.length){
        if(order._trackingInterval){ clearInterval(order._trackingInterval); order._trackingInterval = null; }
      }
    }
  }, 1800);
}

/* ---------- Refund handling ---------- */
document.getElementById('refundBtn').addEventListener('click', () => {
  const id = document.getElementById('refundOrderId').value.trim();
  const reason = document.getElementById('refundReason').value.trim();
  const method = document.getElementById('refundMethod').value;
  if(!id || !reason || !method){ alert('Please provide Order ID, reason, and refund method.'); return; }
  // Show confirm and AI note; actual money handling is out of scope in demo
  document.getElementById('refundConfirm').style.display = 'block';
  addAIMessage(`EcoAssist: Refund request for ${id} received (method: ${method}). Note: payment processing fee (if any) is non-refundable for cancelled orders.`);
  document.getElementById('refundOrderId').value = '';
  document.getElementById('refundReason').value = '';
  document.getElementById('refundMethod').value = '';
  setTimeout(()=>{ document.getElementById('refundConfirm').style.display='none'; }, 4000);
});

/* ---------- Payment option fields (show fee & brief note) ---------- */
const custPayment = document.getElementById('custPayment');
const paymentDetails = document.getElementById('paymentDetails');
custPayment.addEventListener('change', () => {
  const choice = custPayment.value;
  paymentDetails.innerHTML = '';
  if(choice === 'Gcash'){
    paymentDetails.innerHTML = `<div class="small">Processing fee: â‚±${PAYMENT_FEES['Gcash']} (non-refundable on cancel)</div><label class="small">GCash number</label><input id="gcashNumber" placeholder="09XXXXXXXXX">`;
  } else if(choice === 'Bank'){
    paymentDetails.innerHTML = `<div class="small">Processing fee: â‚±${PAYMENT_FEES['Bank']} (non-refundable on cancel)</div>
      <label class="small">Bank</label>
      <select id="bankName"><option value="">Select bank</option><option>BDO</option><option>BPI</option><option>Metrobank</option></select>
      <label class="small" style="margin-top:8px;display:block">Account no.</label><input id="bankAccountNumber" placeholder="Account number">`;
  } else if(choice === 'COD'){
    paymentDetails.innerHTML = `<div class="small">No processing fee for COD.</div>`;
  }
});

/* ---------- AI Chat (fixed) ---------- */
const chatFab = document.getElementById('chatFab');
const chatPanel = document.getElementById('chatPanel');
const chatBody = document.getElementById('chatBody');
const chatInput = document.getElementById('chatInput');
const chatSend = document.getElementById('chatSend');

function openChat(){ chatPanel.style.display = 'flex'; chatInput.focus(); }
function closeChat(){ chatPanel.style.display = 'none'; }
chatFab.addEventListener('click', openChat);
document.getElementById('closeChat').addEventListener('click', closeChat);

function appendChatBubble(role, text){
  const div = document.createElement('div');
  div.className = 'bubble ' + (role === 'user' ? 'user' : 'ai');
  div.textContent = text;
  chatBody.appendChild(div);
  chatBody.scrollTop = chatBody.scrollHeight;
}

function aiReply(text){
  const t = text.toLowerCase();
  if(t.includes('price') || t.includes('cost')) return 'Prices: Bamboo â‚±250, Coconut Fiber Board â‚±300, Fly Ash Concrete â‚±220, Recycled Aggregates â‚±180. Payment fees: GCash â‚±10, Bank â‚±20, COD â‚±0.';
  if(t.includes('refund')) return 'Refunds: use the Refund section. Note: payment processing fees are non-refundable if order is cancelled.';
  if(t.includes('track') || t.includes('status')) return 'Open Order History and click "Track Delivery" for live progress updates; ETA appears in the ETA column.';
  if(t.includes('eta') || t.includes('delivery')) return 'ETA is shown on the receipt and Order History (typically 3â€“5 days after order).';
  if(t.includes('cancel')) return 'To cancel an order, go to Order History and click Cancel on orders marked Pending or Processing.';
  if(t.includes('order')) return 'Place your order using Checkout â€” receipts with Order ID and ETA appear immediately after placing.';
  if(t.includes('hello') || t.includes('hi')) return 'Hi! I\'m EcoAssist â€” I can help with product info, orders, fees, and tracking.';
  return 'I can help with product info, orders, fees, ETA, and refunds â€” try "price", "track", "cancel order", or "refund".';
}

let chatLocked = false;
chatSend.addEventListener('click', () => {
  if(chatLocked) return;
  const txt = chatInput.value.trim();
  if(!txt) return;
  appendChatBubble('user', txt);
  chatInput.value = '';
  chatLocked = true;
  const typing = document.createElement('div');
  typing.id = 'typingDots';
  typing.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
  chatBody.appendChild(typing);
  chatBody.scrollTop = chatBody.scrollHeight;
  setTimeout(()=> {
    const reply = aiReply(txt);
    const dots = document.getElementById('typingDots'); if(dots) dots.remove();
    appendChatBubble('ai', reply);
    chatLocked = false;
  }, 700);
});
setTimeout(()=> appendChatBubble('ai', "Hello! I'm EcoAssist â€” I can help with product info, cart help, fees, and order tracking."), 600);

/* ---------- Utility ---------- */
function addAIMessage(text){
  chatPanel.style.display = 'flex';
  appendChatBubble('ai', text);
}

/* ---------- Initial render ---------- */
renderCart();
renderOrders();
</script>
</body>
</html>
